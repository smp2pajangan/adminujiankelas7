<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Panel Admin Ujian</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <style>
    /* Gaya dasar body */
    body {
      font-family: 'Inter', sans-serif; /* Menggunakan font Inter */
      margin: 0;
      padding: 0;
      background-color: #f4f7f6; /* Warna latar belakang yang lebih terang */
      display: flex; /* Menggunakan flexbox untuk layout utama */
      min-height: 100vh; /* Memastikan body mengisi seluruh tinggi viewport */
      overflow-x: hidden; /* Mencegah scroll horizontal yang tidak diinginkan pada body */
    }

    /* Gaya sidebar */
    .sidebar {
      width: 80px; /* Lebar default (collapsed) */
      background-color: #2c3e50; /* Warna gelap untuk sidebar */
      color: white;
      padding: 20px 0; /* Padding vertikal saja */
      box-shadow: 2px 0 10px rgba(0,0,0,0.1);
      display: flex;
      flex-direction: column;
      align-items: center;
      position: sticky; /* Sidebar tetap di tempatnya saat scroll */
      top: 0;
      height: 100vh; /* Mengisi seluruh tinggi viewport */
      overflow-y: auto; /* Scrollable jika konten sidebar terlalu panjang */
      transition: width 0.3s ease-in-out, padding 0.3s ease-in-out; /* Transisi untuk lebar dan padding */
      flex-shrink: 0; /* Mencegah sidebar menyusut lebih jauh */
      z-index: 20; /* Pastikan sidebar di atas konten utama saat meluncur */
    }

    .sidebar.expanded {
      width: 200px; /* Lebar saat diperluas (diperkecil) */
      padding: 20px;
    }

    .sidebar .logo-container {
      text-align: center;
      margin-bottom: 30px;
      width: 100%; /* Memastikan logo container mengambil lebar penuh */
      padding: 0 10px; /* Padding untuk logo container saat collapsed */
      box-sizing: border-box;
    }

    .sidebar.expanded .logo-container {
      padding: 0; /* Hapus padding saat expanded */
    }

    .sidebar .logo {
      width: 50px; /* Ukuran logo di sidebar saat collapsed (diperkecil) */
      height: 50px; /* Ukuran logo di sidebar saat collapsed (diperkecil) */
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #3498db;
      padding: 3px;
      background-color: white;
      transition: width 0.3s ease-in-out, height 0.3s ease-in-out;
    }

    .sidebar.expanded .logo {
      width: 70px; /* Ukuran logo saat diperluas (diperkecil) */
      height: 70px; /* Ukuran logo saat diperluas (diperkecil) */
    }

    .sidebar h2 {
      font-size: 1em; /* Ukuran font nama sekolah (disesuaikan) */
      margin-top: 10px;
      color: #ecf0f1;
      opacity: 0; /* Sembunyikan teks nama sekolah secara default */
      transition: opacity 0.3s ease-in-out;
      white-space: nowrap; /* Mencegah teks patah baris */
      overflow: hidden; /* Sembunyikan overflow */
      height: 0; /* Sembunyikan tinggi */
    }

    .sidebar.expanded h2 {
      opacity: 1; /* Tampilkan teks nama sekolah saat diperluas */
      height: auto; /* Kembalikan tinggi */
    }

    .sidebar-nav {
      width: 100%;
      flex-grow: 1; /* Memungkinkan navigasi tumbuh */
    }

    .sidebar-nav button {
      background-color: transparent;
      color: white;
      border: none;
      padding: 12px 0; /* Padding vertikal, padding horizontal diatur oleh teks/ikon */
      margin-bottom: 10px;
      width: 100%;
      text-align: center; /* Pusatkan ikon saat collapsed */
      font-size: 16px;
      border-radius: 8px;
      cursor: pointer;
      transition: background-color 0.3s ease, transform 0.2s ease, padding 0.3s ease-in-out;
      display: flex;
      align-items: center;
      justify-content: center; /* Pusatkan ikon saat collapsed */
      gap: 0; /* Tidak ada gap saat collapsed */
    }

    .sidebar-nav button:hover {
      background-color: #34495e;
      transform: translateX(5px);
    }

    .sidebar-nav button.active {
      background-color: #3498db;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .sidebar-nav button i {
      font-size: 18px;
      flex-shrink: 0; /* Mencegah ikon menyusut */
    }

    .sidebar-nav button span {
      opacity: 0; /* Sembunyikan teks menu secara default */
      transition: opacity 0.3s ease-in-out;
      white-space: nowrap;
      overflow: hidden;
      max-width: 0; /* Sembunyikan lebar teks */
    }

    .sidebar.expanded .sidebar-nav button {
        justify-content: flex-start; /* Rata kiri saat diperluas */
        padding-left: 20px; /* Sesuaikan padding agar tidak terlalu mepet tepi */
        gap: 10px; /* Jarak antara ikon dan teks */
    }

    .sidebar.expanded .sidebar-nav button span {
      opacity: 1; /* Tampilkan teks menu saat diperluas */
      max-width: 150px; /* Beri lebar maksimum untuk teks */
    }

    .sidebar .footer {
      width: 100%;
      padding: 20px 10px;
      box-sizing: border-box;
      opacity: 0; /* Sembunyikan footer secara default */
      transition: opacity 0.3s ease-in-out;
      white-space: nowrap;
      overflow: hidden;
      text-align: center;
    }

    .sidebar.expanded .footer {
      opacity: 1; /* Tampilkan footer saat diperluas */
    }

    /* Area konten utama */
    .main-content {
      flex-grow: 1; /* Mengisi sisa ruang */
      padding: 20px;
      background-color: #f4f7f6;
      display: flex;
      flex-direction: column;
      /* overflow-x: auto; Dikelola oleh .table-responsive di dalam */
      overflow-y: auto; /* Memungkinkan scroll vertikal */
      height: 100vh; /* Memastikan main-content mengisi sisa tinggi */
      box-sizing: border-box; /* Pastikan padding termasuk dalam tinggi */
    }

    /* Kontainer untuk bagian */
    .container {
      background: white;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      width: 100%; /* Memastikan container mengisi lebar penuh */
      box-sizing: border-box;
    }

    /* Gaya input, select, textarea */
    input, select, textarea {
      padding: 12px;
      margin: 8px 0;
      width: 100%;
      box-sizing: border-box;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 6px;
      transition: border-color 0.3s ease, box-shadow 0.3s ease;
    }

    input:focus, select:focus, textarea:focus {
      border-color: #3498db;
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.2);
      outline: none;
    }

    /* Gaya tombol */
    button {
      padding: 12px 25px;
      margin: 10px auto;
      display: block;
      font-size: 16px;
      cursor: pointer;
      background-color: #3498db; /* Warna tombol utama */
      color: white;
      border: none;
      border-radius: 6px;
      transition: background-color 0.3s ease, transform 0.2s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    button:hover {
      background-color: #2980b9;
      transform: translateY(-2px);
    }
    button:active {
      transform: translateY(0);
    }

    /* Gaya tombol teks baru */
    .text-button {
        padding: 10px 20px;
        margin: 5px; /* Sesuaikan margin agar tidak terlalu jauh */
        font-size: 15px;
        cursor: pointer;
        border: none;
        border-radius: 6px;
        transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        display: inline-block; /* Agar bisa sejajar */
        text-align: center;
        white-space: nowrap; /* Pastikan teks tidak patah baris */
    }
    .text-button:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    .text-button:active {
        transform: translateY(0);
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    /* Warna spesifik untuk tombol teks */
    .text-button.blue-gray { background-color: #607d8b; color: white; }
    .text-button.blue-gray:hover { background-color: #455a64; }
    .text-button.green { background-color: #4CAF50; color: white; }
    .text-button.green:hover { background-color: #43A047; }
    .text-button.red { background-color: #f44336; color: white; }
    .text-button.red:hover { background-color: #e53935; }
    .text-button.gray { background-color: #9e9e9e; color: white; }
    .text-button.gray:hover { background-color: #757575; }
    .text-button.light-blue { background-color: #2196F3; color: white; }
    .text-button.light-blue:hover { background-color: #1976D2; }
    .text-button.orange { background-color: #FF9800; color: white; }
    .text-button.orange:hover { background-color: #FB8C00; }


    /* Gaya pesan error */
    .error {
      color: #e74c3c;
      font-size: 14px;
      text-align: center;
      margin-top: 5px;
    }
    
    /* Gaya tabel responsif */
    .table-responsive {
        overflow-x: auto; /* Kunci untuk gulir horizontal */
        -webkit-overflow-scrolling: touch;
        border-radius: 8px; /* Sudut membulat untuk tabel */
        overflow-y: hidden; /* Pastikan tidak ada scroll vertikal di sini */
    }
    table {
      width: 100%; /* Agar tabel mengisi lebar container */
      border-collapse: collapse;
      font-size: 14px;
      min-width: 1300px; /* Lebar minimum yang lebih besar untuk tabel token */
    }
    #studentTable {
      min-width: 750px; /* Lebar minimum yang lebih besar untuk tabel siswa */
    }
    #scoreTable {
        min-width: 900px; /* Lebar minimum yang lebih besar untuk tabel nilai */
    }

    th, td {
      border: 1px solid #e0e0e0;
      padding: 10px;
      word-wrap: break-word;
      text-align: left;
    }
    /* Default td max-width, overridden by specific rules */
    td {
        white-space: nowrap; /* Default untuk sel agar tidak patah baris */
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 150px; /* Batasi lebar sel agar tidak terlalu lebar */
    }

    th {
      background-color: #ecf0f1; /* Warna header tabel */
      text-align: center; /* Default center for headers */
      font-weight: bold;
      color: #2c3e50;
      white-space: nowrap; /* Pastikan header tidak patah baris */
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* --- Gaya Khusus Tabel Nilai --- */
    #scoreTableHeader th:nth-child(1),
    #scoreTableBody td:nth-child(1) { /* NO */
        width: 60px;
        min-width: 60px;
        max-width: 60px;
        text-align: center;
    }
    #scoreTableHeader th:nth-child(2) { /* NAMA SISWA Header */
        text-align: center; /* Diubah menjadi rata tengah */
        width: auto; /* Lebar otomatis */
        white-space: normal; /* Izinkan teks membungkus */
    }
    #scoreTableBody td:nth-child(2) { /* NAMA SISWA Body */
        text-align: left; /* Nama siswa tetap rata kiri */
        width: auto;
        white-space: normal; /* Izinkan teks membungkus */
    }
    #scoreTableHeader th:nth-child(3),
    #scoreTableBody td:nth-child(3) { /* KELAS */
        width: 80px;
        min-width: 80px;
        max-width: 80px;
        text-align: center;
    }
    /* Kolom Mata Pelajaran di Header Tabel Nilai (setelah NO, NAMA SISWA, KELAS) */
    #scoreTableHeader th:not(:nth-child(1)):not(:nth-child(2)):not(:nth-child(3)) {
        text-align: center; /* Rata tengah untuk singkatan mapel */
        font-style: italic; /* Teks miring */
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        max-width: 100px; /* Lebar maksimum tetap untuk singkatan */
        min-width: 80px; /* Minimum width for abbreviation */
        width: 100px;
    }

    /* Kolom Nilai di Body Tabel Nilai (setelah NO, NAMA SISWA, KELAS) */
    #scoreTableBody td:not(:nth-child(1)):not(:nth-child(2)):not(:nth-child(3)) { 
        text-align: center; /* Rata tengah untuk nilai */
        max-width: 80px; /* Batasi lebar kolom nilai */
        min-width: 80px;
        width: 80px;
    }
    /* --- Akhir Gaya Khusus Tabel Nilai --- */


    tr:nth-child(even) {
        background-color: #f9f9f9; /* Warna zebra striping */
    }

    /* Penjajaran khusus untuk Tabel Pengaturan Lokasi */
    #locationSettingsTableBody td:nth-child(1) { text-align: center; }
    #locationSettingsTableBody td:nth-child(2) { text-align: center; }
    #locationSettingsTableBody td:nth-child(3) { text-align: center; }
    #locationSettingsTableBody td:nth-child(4) { text-align: center; }
    #locationSettingsTableBody td:nth-child(4) button {
      display: inline-block;
      margin: 0;
    }

    /* Penjajaran khusus untuk Tabel Daftar Token */
    #tokenTableBody td:nth-child(1) { text-align: center; } /* NO */
    #tokenTableBody td:nth-child(3) { text-align: center; } /* KELAS */
    #tokenTableBody td:nth-child(4) { text-align: center; } /* TOKEN */
    #tokenTableBody td:nth-child(6) { text-align: center; } /* KUNJAB (NEW) */
    #tokenTableBody td:nth-child(7) { text-align: center; } /* TOKEN DIBUKA (shifted from 6) */
    #tokenTableBody td:nth-child(8) { text-align: center; } /* TOKEN DITUTUP (shifted from 7) */
    #tokenTableBody td:nth-child(9) { text-align: center; } /* DURASI (MENIT) (shifted from 8) */
    #tokenTableBody td:nth-child(10) { text-align: center; } /* STATUS (shifted from 9) */
    #tokenTableBody td:nth-child(11) { text-align: center; } /* AKSES (shifted from 10) */
    #tokenTableBody td:nth-child(12) { text-align: center; } /* SUBMIT (shifted from 11) */
    #tokenTableBody td:nth-child(13) { text-align: center; } /* AKSI (shifted from 12) */

    /* Penjajaran khusus untuk Tabel Daftar Siswa */
    #studentTableBody td:nth-child(1) { text-align: center; } /* NO */
    #studentTableBody td:nth-child(2) { text-align: center; } /* ID SISWA */
    #studentTableBody td:nth-child(4) { text-align: center; } /* KELAS */
    #studentTableBody td:nth-child(5) { text-align: center; } /* RUANG */
    #studentTableBody td:nth-child(6) { text-align: center; } /* STATUS */
    #studentTableBody td:last-child { text-align: center; } /* AKSI */

    /* Gaya untuk tombol edit/hapus siswa agar sejajar */
    .student-action-buttons {
        display: flex;
        justify-content: center;
        gap: 5px;
        flex-wrap: nowrap; /* Pastikan tombol tidak patah baris */
        flex-shrink: 0; /* Mencegah container menyusut */
    }
    .student-action-buttons button {
        margin: 0;
        padding: 0;
        background: none;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 28px; /* Ukuran tombol */
        height: 28px; /* Ukuran tombol */
        border-radius: 50%; /* Membuat tombol bulat */
        transition: background-color 0.2s ease;
        flex-shrink: 0; /* Pastikan tombol tidak menyusut */
    }
    .student-action-buttons button:hover {
        background-color: #e0e0e0;
    }
    .student-action-buttons button i { /* Untuk ikon font-awesome */
        font-size: 16px;
        color: #34495e; /* Warna default untuk ikon aksi */
    }
    .student-action-buttons button:hover i {
        color: #2c3e50;
    }
    .student-action-buttons button img {
        width: 16px; /* Ukuran ikon */
        height: 16px; /* Ukuran ikon */
    }

    /* Gaya footer */
    .footer {
      text-align: center;
      margin-top: 20px;
      color: #7f8c8d;
      font-size: 13px;
    }
    .date-time {
      font-size: 14px;
      color: #555;
    }
    /* Gaya modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000; /* Lebih tinggi dari elemen lain */
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6); /* Latar belakang modal lebih gelap */
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      width: 90%;
      max-width: 450px; /* Maks lebar modal */
      box-sizing: border-box;
      box-shadow: 0 8px 16px rgba(0,0,0,0.2);
      text-align: center;
    }
    .modal h4 {
        color: #2c3e50;
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.5em;
    }
    .modal p {
        margin-bottom: 20px;
        color: #34495e;
    }
    .modal button {
      margin: 8px;
      display: inline-block;
      width: auto;
      min-width: 100px;
      padding: 10px 20px;
      font-size: 15px;
    }
    .modal button.confirm-button {
        background-color: #28a745; /* Hijau untuk konfirmasi */
    }
    .modal button.confirm-button:hover {
        background-color: #218838;
    }
    .modal button.cancel-button {
        background-color: #dc3545; /* Merah untuk batal */
    }
    .modal button.cancel-button:hover {
        background-color: #c82333;
    }
    .login-link {
      color: #3498db;
      text-decoration: underline;
      font-weight: bold;
      transition: color 0.3s ease;
    }
    .login-link:hover {
      color: #2980b9;
      cursor: pointer;
    }
    .login-link:active {
      color: #e74c3c;
    }
    
    .icon-button { /* Ini untuk ikon yang tetap ada di dalam tabel */
      background: none;
      border: none;
      cursor: pointer;
      padding: 8px;
      margin: 0;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 28px; /* Ukuran tombol */
      height: 28px; /* Ukuran tombol */
      border-radius: 50%; /* Membuat tombol bulat */
      transition: background-color 0.2s ease;
    }
    .icon-button:hover {
      background-color: #e0e0e0;
    }
    .icon-button img {
      width: 20px;
      height: 20px;
      display: block;
    }

    /* Penyesuaian khusus mobile */
    @media (max-width: 768px) {
      body {
        flex-direction: column; /* Tumpuk sidebar dan konten utama */
      }
      .sidebar {
        width: 100%; /* Lebar penuh untuk sidebar */
        height: auto; /* Tinggi otomatis */
        position: relative; /* Tidak sticky di mobile */
        border-radius: 0; /* Tanpa sudut di mobile */
        padding: 15px 10px;
      }
      .sidebar.expanded { /* Di mobile, expanded tetap lebar penuh */
        width: 100%;
      }
      .sidebar .logo-container {
        padding: 0; /* Hapus padding di mobile */
      }
      .sidebar .logo {
        width: 40px; /* Lebih kecil di mobile */
        height: 40px;
      }
      .sidebar.expanded .logo { /* Logo tetap ukuran mobile saat expanded di mobile */
        width: 40px;
        height: 40px;
      }
      .sidebar h2 {
        font-size: 0.9em; /* Lebih kecil di mobile */
        height: auto; /* Selalu tampil di mobile */
        opacity: 1;
      }
      .sidebar-nav {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 8px;
        margin-top: 15px;
      }
      .sidebar-nav button {
        width: auto; /* Lebar otomatis */
        padding: 10px 12px;
        font-size: 14px;
        flex-grow: 1; /* Biarkan tombol tumbuh */
        justify-content: center; /* Pusatkan teks dan ikon */
      }
      .sidebar-nav button span {
        display: none; /* Sembunyikan teks menu di mobile sangat kecil */
      }
      .sidebar-nav button i {
        margin-right: 0; /* Hapus margin ikon */
      }
      .sidebar.expanded .sidebar-nav button span { /* Teks menu tetap tersembunyi di mobile */
        display: none;
      }
      .sidebar .footer {
        opacity: 1; /* Selalu tampil di mobile */
        height: auto;
      }
      /* Tidak ada tombol sidebar-toggle di mobile */

      .main-content {
        padding: 15px;
        height: auto; /* Izinkan tinggi menyesuaikan berdasarkan konten */
        min-height: 100vh; /* Pastikan mengambil setidaknya tinggi viewport penuh */
      }
      /* Header-content dihapus, jadi tidak perlu penyesuaian mobile */
      .container {
        padding: 15px;
      }

      input, select, textarea {
        font-size: 14px;
        padding: 10px;
      }
      button {
        font-size: 14px;
        padding: 10px 20px;
      }
      table {
        font-size: 11px;
        /* min-width diatur di luar media query agar tetap lebar */
      }
      th, td {
        padding: 8px;
      }
      /* Hapus semua display: none untuk kolom di mobile */
      /* Tabel akan mengandalkan overflow-x: auto pada .table-responsive */
    }

    @media (max-width: 480px) {
      .sidebar-nav button span {
        display: none; /* Pastikan teks menu hilang */
      }
      .sidebar-nav button {
        padding: 10px; /* Hanya ikon */
      }
    }

    /* Gaya notifikasi */
    #notification {
      display: none;
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background-color: #28a745; /* Warna notifikasi hijau */
      color: white;
      padding: 15px 25px;
      border-radius: 8px;
      z-index: 10000; /* Pastikan di atas semua modal */
      text-align: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      font-weight: bold;
    }
    
    /* Overlay loading */
    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 255, 255, 0.8);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 99999; /* Sangat tinggi */
    }

    .spinner {
        border: 5px solid rgba(0, 0, 0, 0.1);
        width: 40px;
        height: 40px;
        border-radius: 50%;
        border-left-color: #3498db; /* Warna spinner */
        animation: spin 1s ease infinite;
    }

    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Gaya untuk filter kelas di bagian nilai ujian */
    .score-filters-container {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 15px;
        align-items: center;
    }
    .score-filters-container button {
        flex-grow: 1;
        margin: 0;
        padding: 8px 15px;
        font-size: 14px;
        background-color: #f0f0f0;
        color: #333;
        border: 1px solid #ccc;
        box-shadow: none;
    }
    .score-filters-container button.active {
        background-color: #3498db;
        color: white;
        border-color: #3498db;
    }
    .score-filters-container input[type="text"] {
        flex-grow: 1;
        max-width: 200px;
        margin: 0;
    }
    .score-filters-container .filter-group {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }

    /* Gaya untuk input kunci jawaban yang dibagi 2 */
    .answer-key-input-group {
        display: flex;
        gap: 10px;
        align-items: flex-end; /* Align items to the bottom */
        margin: 8px 0;
    }
    .answer-key-input-group > div {
        display: flex;
        flex-direction: column;
    }
    .answer-key-input-group label {
        font-size: 0.8em;
        color: #555;
        margin-bottom: 2px; /* Small margin below label */
    }
    .answer-key-input-group input {
        margin: 0; /* Remove default margin */
        height: auto; /* Allow height to adjust */
    }
    .answer-key-input-group .count-input {
        flex-shrink: 0;
        width: 80px; /* Fixed width for count input */
        text-align: center;
        background-color: #e9ecef;
        cursor: default;
    }
    .answer-key-input-group .key-input {
        flex-grow: 1; /* Take remaining space */
    }
  </style>
</head>
<body>
  <div class="sidebar" id="sidebar">
    <div class="logo-container">
      <img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/logosmpn2pjg.png" alt="Logo SMPN 2 Pajangan" class="logo">
      <h2>SMPN 2 PAJANGAN</h2> </div>
    <nav class="sidebar-nav">
      <button id="tokenMenuBtn" data-section-id="tokenSection" onclick="handleMenuClick(this)">
        <i class="fas fa-key"></i> <span>Token</span>
      </button>
      <button id="pesertaMenuBtn" data-section-id="studentSection" onclick="handleMenuClick(this)">
        <i class="fas fa-users"></i> <span>Peserta</span>
      </button>
      <button id="scoreMenuBtn" data-section-id="scoreSection" onclick="handleMenuClick(this)">
        <i class="fas fa-chart-bar"></i> <span>Nilai Ujian</span>
      </button>
      <button id="lokasiMenuBtn" data-section-id="locationSection" onclick="handleMenuClick(this)">
        <i class="fas fa-map-marker-alt"></i> <span>Lokasi</span>
      </button>
      <button data-action="promptLogout" onclick="handleMenuClick(this)">
        <i class="fas fa-sign-out-alt"></i> <span>Keluar</span>
      </button>
    </nav>
    <div class="footer" style="margin-top: auto; padding-top: 20px;">
      <div>@Admin SMPN 2 Pajangan</div>
      <div id="adminDateTime" class="date-time" style="color: #bdc3c7;"></div>
    </div>
  </div>

  <div class="main-content" id="mainContent">
    <div class="container" id="loginSection">
      <h3 style="text-align: center; color: #2c3e50;">LOGIN ADMINISTRASI</h3>
      <p id="loginError" class="error"></p>
      <input type="text" id="username" placeholder="Username" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
      <p style="text-align: center; font-size: 14px; margin-top: 10px;">
        Halaman login ujian siswa?
        <a href="http://smp2pajangan.github.io/loginujian" class="login-link">Loginujian</a>
      </p>
      <div class="footer">
        <div>@Admin SMPN 2 Pajangan</div>
        <div id="currentTime" class="date-time"></div>
      </div>
    </div>

    <div id="dashboardContent" style="display:none;">
      <div id="tokenSection" class="dashboard-section container">
        <h1 id="tokenSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Manajemen Token</h1>
        <h3>TAMBAH / EDIT TOKEN</h3>
        <form id="tokenForm">
          <label>Mata Pelajaran</label>
          <input type="text" id="subject" placeholder="Gunakan kapital" required />
          <label>Kelas</label>
          <input type="text" id="kelas" placeholder="Berupa angka saja (7, 8, atau 9)" required />
          <label>Token Ujian (Base Token)</label>
          <input type="text" id="token" placeholder="Berupa huruf/angka (gunakan kapital)" required />
          
          <label for="googleDriveUrl">Link Google Drive PDF Soal</label>
          <input type="url" id="googleDriveUrl" placeholder="Contoh: https://drive.google.com/file/d/FILE_ID/view?usp=sharing" required />
          <p id="googleDriveUrlError" class="error"></p>

          <div class="answer-key-input-group">
            <div class="count-input-container">
              <label for="answerKeyCount">Jumlah Soal</label>
              <input type="text" id="answerKeyCount" readonly class="count-input" value="0" />
            </div>
            <div class="key-input-container">
              <label for="answerKey">Kunci Jawaban</label>
              <input type="text" id="answerKey" placeholder="Contoh: A,B,C,D,D" required class="key-input" />
            </div>
          </div>
          <p id="answerKeyError" class="error"></p>

          <label>Waktu Token Dibuka</label>
          <input type="datetime-local" id="startTime" required />
          <label>Waktu Token Ditutup</labeL>
          <input type="datetime-local" id="endTime" required />
          <button type="submit">Tambah</button>
          <p id="errorMsg" class="error"></p>
        </form>

        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; margin-top: 30px;">
          <h3 style="margin-bottom: 0;">DAFTAR TOKEN</h3>
          <button class="text-button blue-gray" onclick="openCopyPrintModal('tokenTable', 'Cetak Daftar Token')">Cetak</button>
        </div>

        <p style="font-size: 11px; color: #555; margin-top: -10px; margin-bottom: 10px; text-align: center;">
          Token yang ditambahkan akan dihapus otomatis setelah 30 hari!
        </p>

        <div class="table-responsive">
          <table id="tokenTable">
            <thead>
              <tr>
                <th>NO</th>
                <th>MAPEL</th>
                <th>KELAS</th>
                <th>TOKEN</th>
                <th>PDF</th>
                <th>KUNJAB</th> <th>TOKEN DIBUKA</th>
                <th>TOKEN DITUTUP</th>
                <th>DURASI</th>
                <th>STATUS</th>
                <th>AKSES</th>
                <th>SUBMIT</th>
                <th>AKSI</th>
              </tr>
            </thead>
            <tbody id="tokenTableBody"></tbody>
          </table>
        </div>
      </div>

      <div id="locationSection" class="dashboard-section container">
        <h1 id="locationSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Pengaturan Lokasi</h1>
        <div style="margin-bottom: 20px;">
          <h3>ATUR AKSES LOKASI</h3>
          <div class="table-responsive">
            <table id="locationSettingsTable">
              <thead>
                <tr>
                  <th>KOORDINAT LOKASI</th>
                  <th>RADIUS</th>
                  <th>STATUS</th>
                  <th>AKSI</th>
                </tr>
              </thead>
              <tbody id="locationSettingsTableBody">
                </tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="studentSection" class="dashboard-section container">
        <h1 id="studentSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Manajemen Peserta</h1>
        <div style="margin-bottom: 20px;">
          <h3>MANAJEMEN SISWA</h3>
          <form id="studentForm">
            <label>ID Siswa</label>
            <input type="text" id="studentId" placeholder="Contoh: 001" required />
            <label>Nama Siswa</label>
            <input type="text" id="studentName" placeholder="Nama Lengkap Siswa" required />
            <label>Kelas</label>
            <input type="text" id="studentClass" placeholder="Contoh: 7A, 8B, 9C" required />
            <label>Ruang</label>
            <input type="text" id="studentRoom" placeholder="Contoh: 01, 02, dsb" required /> 
            <button type="submit" id="addStudentButton">Tambah Siswa</button>
            <button type="button" id="updateStudentButton" style="display:none;">Perbarui Siswa</button>
            <p id="studentErrorMsg" class="error"></p>
          </form>

          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 10px;">
            <h3 style="margin-bottom: 0;">DAFTAR SISWA</h3>
            <div style="display: flex; gap: 10px;">
              <button class="text-button green" onclick="openImportStudentModal()">Impor Siswa</button>
              <button class="text-button red" onclick="openEmptyStudentsModal()">Kosongkan Daftar</button>
              <button class="text-button gray" onclick="showPrintInfoModal()">Cetak Kartu</button>
            </div>
          </div>

          <div class="student-filters-container">
              <div>
                  <label for="classFilterDropdownSelect">KELAS:</label>
                  <select id="classFilterDropdownSelect" onchange="filterStudentsByClass(this.value)">
                      <option value="">SEMUA KELAS</option>
                      </select>
              </div>
              <div>
                  <label for="examStatusFilter">STATUS UJIAN:</label>
                  <select id="examStatusFilter" onchange="filterStudentsByExamStatus(this.value)">
                      <option value="">TOKEN SAAT INI</option>
                      </select>
              </div>
          </div>

          <div class="table-responsive">
            <table id="studentTable">
              <thead>
                <tr>
                  <th>NO</th>
                  <th>ID SISWA</th>
                  <th>NAMA</th>
                  <th>KELAS</th>
                  <th>RUANG</th>
                  <th>STATUS</th>
                  <th>AKSI</th>
                </tr>
              </thead>
            <tbody id="studentTableBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="scoreSection" class="dashboard-section container">
        <h1 id="scoreSectionTitle" style="text-align: left; margin-bottom: 20px; color: #34495e;">Daftar Nilai Ujian</h1>
        <div class="score-filters-container">
            <div class="filter-group">
                <button id="filterClass7" onclick="filterScoresByGrade(7)">Kelas 7</button>
                <button id="filterClass8" onclick="filterScoresByGrade(8)">Kelas 8</button>
                <button id="filterClass9" onclick="filterScoresByGrade(9)">Kelas 9</button>
            </div>
            <input type="text" id="scoreSearchName" placeholder="Cari Nama Siswa" onkeyup="renderScoreTable()" />
            <input type="text" id="scoreSearchClass" placeholder="Cari Kelas (misal: 7A)" onkeyup="renderScoreTable()" />
            <div style="display: flex; gap: 10px;">
                <button class="text-button light-blue" onclick="openCopyPrintModal('scoreTable', 'Cetak Daftar Nilai')">Cetak</button>
            </div>
        </div>
        <div class="table-responsive">
          <table id="scoreTable">
            <thead>
              <tr id="scoreTableHeader">
                <th>NO</th>
                <th>NAMA SISWA</th>
                <th>KELAS</th>
                </tr>
            </thead>
            <tbody id="scoreTableBody"></tbody>
          </table>
        </div>
      </div>
      </div>
  </div>

  <div id="editModal" class="modal">
    <div class="modal-content">
      <h4>Edit Token</h4>
      <form id="modalForm">
        <label>Mata Pelajaran</label>
        <input type="text" id="editSubject" required />
        <label>Kelas</label>
        <input type="text" id="editKelas" placeholder="Berupa angka saja (7, 8, atau 9)" required />
        <label>Token Ujian</label>
        <input type="text" id="editToken" required />
        
        <label for="editGoogleDriveUrl">Link Google Drive PDF Soal</label>
        <input type="url" id="editGoogleDriveUrl" placeholder="Contoh: https://drive.google.com/file/d/FILE_ID/view?usp=sharing" required />
        <p id="editGoogleDriveUrlError" class="error"></p>

        <div class="answer-key-input-group">
          <div class="count-input-container">
            <label for="editAnswerKeyCount">Jumlah Soal</label>
            <input type="text" id="editAnswerKeyCount" readonly class="count-input" value="0" />
          </div>
          <div class="key-input-container">
            <label for="editAnswerKey">Kunci Jawaban</label>
            <input type="text" id="editAnswerKey" placeholder="Hanya A,B,C,D dipisah koma" required class="key-input" />
          </div>
        </div>
        <p id="editAnswerKeyError" class="error"></p>

        <label>Waktu Token Dibuka</label>
        <input type="datetime-local" id="editStartTime" required />
        <label>Waktu Token Ditutup</labeL>
        <input type="datetime-local" id="editEndTime" required />
        <p id="editErrorMsg" class="error"></p>
        <button type="submit">Simpan</button>
        <button type="button" onclick="closeEditModal()" class="cancel-button">Batal</button>
      </form>
    </div>
  </div>

  <div id="deleteModal" class="modal">
    <div class="modal-content">
      <p>Yakin ingin menghapus token ini?</p>
      <button onclick="confirmDelete()" class="confirm-button">Hapus</button>
      <button onclick="closeDeleteModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="forceActiveModal" class="modal">
    <div class="modal-content">
      <p>Apakah Anda yakin ingin <b>mengaktifkan token secara paksa</b>? Hal ini akan membuat token dapat diakses kapanpun!</p>
      <div>
        <label for="forceActivePassword">Password:</label>
        <input type="password" id="forceActivePassword">
        <p id="forceActivePasswordError" class="error"></p>
      </div>
      <button onclick="confirmForceActive()" class="confirm-button">Mengaktifkan</button>
      <button onclick="closeForceActiveModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="forceInactiveModal" class="modal">
    <div class="modal-content">
      <p>Apakah Anda yakin ingin <b>menonaktifkan token secara paksa</b>? Hal ini akan membuat token kembali ke pengaturan jadwal!</p>
      <button onclick="confirmForceInactive()" class="confirm-button">Nonaktifkan</button>
      <button onclick="closeForceInactiveModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="notification">
    <span id="notificationMessage"></span>
  </div>

  <div id="copyPrintModal" class="modal">
    <div class="modal-content">
      <h4 id="copyPrintModalTitle"></h4>
      <button onclick="copyTableToClipboard()" class="confirm-button">Salin Tabel</button>
      <p style="font-size: 0.9em; color: #555; margin-top: 15px;">
        Salin tabel kemudian paste ke word atau excel.
      </p>
      <button onclick="closeCopyPrintModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="printInfoModal" class="modal">
    <div class="modal-content">
        <span class="close-button" onclick="closePrintInfoModal()">Ã—</span>
        <p style="margin-bottom: 20px;">
            Maaf, sementara cetak kartu belum bisa. Silahkan download 2 file excel dan word dibawah ini:
        </p>
        <p style="margin-bottom: 10px;">
            <a href="https://drive.google.com/uc?export=download&id=1rLFyKUzQloJi7LAnO-x7Q-lK0BzdxQv3" target="_blank">File Word (disini)</a>
        </p>
        <p style="margin-bottom: 20px;">
            <a href="https://drive.google.com/uc?export=download&id=14uoOXQScECxd9hXD4AIMJjFBlmbSAgxS" target="_blank">File Excel (disini)</a>
        </p>
        <p style="font-size: 14px; color: #555;">
            **Catatan:** ISI ID_SISWA SESUAI DENGAN TEMPLATE CSV!
        </p>
    </div>
  </div>

  <div id="setlokasiModal" class="modal">
    <div class="modal-content" style="text-align: center;">
      <h4>Pengaturan Lokasi</h4>
      <button onclick="aktifkanLokasi()" style="background-color: #28a745; color: white;">Aktifkan</button>
      <button onclick="openGantiRadiusModal()" style="background-color: #ffc107; color: black;">Ganti Radius</button>
      <button onclick="nonaktifkanLokasi()" style="background-color: #dc3545; color: white;">Nonaktifkan</button>
      <button onclick="closeSetlokasiModal()" class="cancel-button" style="margin-top: 10px;">Batal</button>
    </div>
  </div>

  <div id="gantiRadiusModal" class="modal">
    <div class="modal-content">
      <h4>Ganti Radius Lokasi (meter)</h4>
      <label for="radiusMeter">Radius (meter):</label>
      <input type="number" id="radiusMeter" placeholder="Contoh: 75" required />
      <div style="text-align: center; margin-top: 10px;">
        <button onclick="gantiRadiusDanAktifkan()">Ganti & Aktifkan</button>
        <button onclick="closeGantiRadiusModal()" class="cancel-button">Batal</button>
      </div>
    </div>
  </div>

  <div id="accessDetailModal" class="modal">
    <div class="modal-content" style="max-width: 700px;">
      <h4 id="accessDetailTokenTitle">Detail Akses Token: [Token]</h4>
      <div class="table-responsive">
        <table id="accessDetailTable">
          <thead>
            <tr>
              <th>NO</th>
              <th>ID SISWA</th>
              <th>NAMA SISWA</th>
              <th>KELAS</th>
              <th>STATUS AKSES</th>
              <th>WAKTU AKSES PERTAMA</th>
            </tr>
          </thead>
          <tbody id="accessDetailTableBody">
            </tbody>
        </table>
      </div>
      <button onclick="closeAccessDetailModal()" style="margin-top: 20px;">Tutup</button>
    </div>
  </div>

  <div id="editStudentModal" class="modal">
    <div class="modal-content">
      <h4>Edit Data Siswa</h4>
      <p id="editStudentErrorMsg" class="error"></p>
      <label for="modalStudentId">ID Siswa</label>
      <input type="text" id="modalStudentId" required />
      <label for="modalStudentName">Nama Siswa</label>
      <input type="text" id="modalStudentName" required />
      <label for="modalStudentClass">Kelas</label>
      <input type="text" id="modalStudentClass" placeholder="Contoh: 7A, 8B, 9C" required />
      <label for="modalStudentRoom">Ruang</label>
      <input type="text" id="modalStudentRoom" placeholder="Contoh: 01, 02, dsb" required /> 
      <button onclick="confirmEditStudent()">Simpan</button>
      <button type="button" onclick="closeEditStudentModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="deleteStudentConfirmModal" class="modal">
    <div class="modal-content">
      <p>Yakin ingin menghapus siswa ini?</p>
      <button onclick="confirmDeleteStudent()" class="confirm-button">Hapus</button>
      <button onclick="closeDeleteStudentConfirmModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="importStudentModal" class="modal">
    <div class="modal-content">
      <h4>Import Data Peserta dari CSV</h4>
      <p style="font-size: 0.9em; color: #555; text-align: left;">
        Perhatikan hal-hal berikut!<br>
        1. Siapkan data peserta dengan 4 kolom: ID Peserta (angka), Nama Lengkap, Kelas, dan Ruang<br>
        2. Simpan file dengan format *.csv (comma delimited)<br>
        3. Pastikan tidak ada kolom tambahan
      </p>
      <a href="https://drive.google.com/uc?export=download&id=16rzsLjQ3AVm0wIPqWnzsauzbrwGfO7An" target="_blank" style="display: block; text-align: center; margin: 15px 0; padding: 10px 20px; background-color: #28a745; color: white; text-decoration: none; border-radius: 5px;">Unduh Template CSV</a> 
      <input type="file" id="csvFileInput" accept=".csv" style="margin-top: 15px; margin-bottom: 10px;" />
      <p id="importFileError" class="error"></p>
      <button onclick="processCsvFile()">Mulai Impor</button>
      <button onclick="closeImportStudentModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="importResultModal" class="modal">
    <div class="modal-content">
      <h4>Hasil Impor Data Siswa</h4>
      <p id="importResultSummary"></p>
      <ul id="importResultDetails" style="text-align: left; max-height: 200px; overflow-y: auto; border: 1px solid #eee; padding: 10px; border-radius: 5px;"></ul>
      <button onclick="closeImportResultModal()">Tutup</button>
    </div>
  </div>

  <div id="emptyStudentsModal" class="modal">
    <div class="modal-content">
      <h4>Kosongkan Daftar Peserta</h4>
      <p>Anda yakin ingin menghapus <b>SEMUA</b> data peserta? Tindakan ini tidak dapat dibatalkan.</p>
      <div>
        <label for="emptyStudentsPassword">Password Admin:</label>
        <input type="password" id="emptyStudentsPassword">
        <p id="emptyStudentsPasswordError" class="error"></p>
      </div>
      <button onclick="confirmEmptyStudents()" class="confirm-button">Konfirmasi Hapus Semua</button>
      <button onclick="closeEmptyStudentsModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="logoutConfirmModal" class="modal">
    <div class="modal-content">
      <h4>Konfirmasi Logout</h4>
      <p>Anda yakin ingin keluar dari panel admin?</p>
      <button onclick="confirmLogout()" class="confirm-button">Ya, Keluar</button>
      <button onclick="closeLogoutModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="resetStudentModal" class="modal">
    <div class="modal-content">
      <h4>Reset Status Login Siswa</h4>
      <p>Anda yakin ingin mereset status login siswa <b id="resetStudentNameDisplay"></b> (ID: <b id="resetStudentIdDisplay"></b>)?</p>
      <p style="font-size: 0.9em; color: #555;">Ini akan memaksa siswa untuk login ulang jika mereka sedang dalam sesi.</p>
      <button onclick="confirmResetStudent()" class="confirm-button">Reset</button>
      <button onclick="closeResetStudentModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="submitAnswerModal" class="modal">
    <div class="modal-content">
      <h4>Kirim Jawaban Siswa (Manual)</h4>
      <p>Anda yakin ingin menandai semua ujian yang sedang dikerjakan siswa <b id="submitStudentNameDisplay"></b> (ID: <b id="submitStudentIdDisplay"></b>) sebagai 'Sudah submit'?</p>
      <p style="font-size: 0.9em; color: #555;">Tindakan ini akan mengunci jawaban siswa untuk ujian yang relevan.</p>
      <button onclick="confirmSubmitAnswer()" class="confirm-button">Kirim Jawaban</button>
      <button onclick="closeSubmitAnswerModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="deleteAnswerModal" class="modal">
    <div class="modal-content">
      <h4>Hapus Semua Jawaban Siswa</h4>
      <p>Anda yakin ingin menghapus <b>SEMUA</b> jawaban dan status submit untuk siswa <b id="deleteAnswerStudentNameDisplay"></b> (ID: <b id="deleteAnswerStudentIdDisplay"></b>)?</p>
      <p style="font-size: 0.9em; color: #e74c3c; font-weight: bold;">Tindakan ini tidak dapat dibatalkan!</p>
      <div>
        <label for="deleteAnswerPassword">Password Admin:</label>
        <input type="password" id="deleteAnswerPassword">
        <p id="deleteAnswerPasswordError" class="error"></p>
      </div>
      <button onclick="confirmDeleteAnswer()" class="confirm-button">Hapus Jawaban</button>
      <button onclick="closeDeleteAnswerModal()" class="cancel-button">Batal</button>
    </div>
  </div>

  <div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner"></div>
  </div>


  <script type="module">
    // Import fungsi yang dibutuhkan dari SDK yang dibutuhkan
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js";
    import { getDatabase, ref, push, onValue, update, remove, runTransaction, get } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-database.js";

    // --- Konfigurasi Firebase untuk setiap kelas ---
    const firebaseConfig7 = {
      apiKey: "AIzaSyCII45EsItVdjv3zHSL5CaBQ4nF45z4IuM",
      authDomain: "ujiankupdf.firebaseapp.com",
      databaseURL: "https://ujiankupdf-default-rtdb.firebaseio.com",
      projectId: "ujiankupdf",
      storageBucket: "ujiankupdf.firebasestorage.app",
      messagingSenderId: "302885602120",
      appId: "1:302885602120:web:e0839370e6d667cda6297d"
    };

    const firebaseConfig8 = {
      apiKey: "AIzaSyDqxYYrYzae5y9lqwQTXS6VoYgBtFWME8I",
      authDomain: "ujianonlinepdf8-9d913.firebaseapp.com",
      databaseURL: "https://ujianonlinepdf8-9d913-default-rtdb.firebaseio.com",
      projectId: "ujianonlinepdf8-9d913",
      storageBucket: "ujianonlinepdf8-9d913.firebasestorage.app",
      messagingSenderId: "487436559172",
      appId: "1:487436559172:web:80d78ed209f0ada59eed11"
    };

    const firebaseConfig9 = {
      apiKey: "AIzaSyCUReE6pmkleeR7jIz3sPO9N943v96uUro",
      authDomain: "ujianonlinepdf9-c7aba.firebaseapp.com",
      databaseURL: "https://ujianonlinepdf9-c7aba-default-rtdb.firebaseio.com",
      projectId: "ujianonlinepdf9-c7aba",
      storageBucket: "ujianonlinepdf9-c7aba.firebasestorage.app",
      messagingSenderId: "382098344813",
      appId: "1:382098344813:web:f3eb483dca58c21e56a864"
    };

    // Inisialisasi Aplikasi Firebase
    const app7 = initializeApp(firebaseConfig7, 'app7');
    const db7 = getDatabase(app7);

    const app8 = initializeApp(firebaseConfig8, 'app8');
    const db8 = getDatabase(app8);

    const app9 = initializeApp(firebaseConfig9, 'app9');
    const db9 = getDatabase(app9);

    // Memetakan nomor kelas ke instance database masing-masing
    const classDbMap = {
        '7': db7,
        '8': db8,
        '9': db9
    };

    // Kredensial Admin
    const ADMIN_USER = "admin";
    const ADMIN_PASS = "12345678";
    let currentTokenId = null;
    let currentStudentKey = null; // Untuk mengedit/menghapus siswa
    let deleteStudentKey = null; // Untuk konfirmasi penghapusan siswa
    let tokenCache = []; // Cache terpadu untuk semua token dari semua kelas
    let studentCache = []; // Cache terpadu untuk semua siswa dari semua kelas
    let tokenAccessStatus = {}; // Cache untuk status akses token per siswa (terpadu)
    let submittedExamsCache = {}; // Cache untuk status pengiriman ujian (terpadu)
    let studentAnswersCache = {}; // NEW: Cache untuk jawaban siswa (terpadu)
    const THIRTY_DAYS_IN_MS = 30 * 24 * 60 * 60 * 1000; // 30 hari dalam milidetik
    const EDIT_ICON_URL = "https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/edit.png";
    const DELETE_ICON_URL = "https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/hapus.png";
    let inactivityTimer;
    const INACTIVITY_TIMEOUT = 60 * 60 * 1000; // Batas waktu tidak aktif 1 jam
    let currentForceActiveTokenId = null;
    let isImporting = false; // Flag untuk mencegah impor ganda
    let currentStudentClassFilter = null; // Filter untuk daftar siswa (misalnya, '7A', '7_all', atau null untuk semua)
    let currentExamStatusFilterToken = null; // Filter untuk status ujian (kunci token)

    // Referensi ke node 'setlokasi' di Firebase (asumsi ini global dan bukan per kelas)
    // Jika setlokasi perlu per kelas, ini perlu disesuaikan. Untuk saat ini, diasumsikan global.
    const settingsRef = ref(db7, 'setlokasi'); // Menggunakan db7 sebagai yang utama untuk pengaturan global

    // Variabel untuk menyimpan status lokasi dan radius
    let isLocationEnabledAdmin = false;
    let allowedRadiusMeterAdmin = 75; // Default dalam meter
    // Koordinat default untuk akses lokasi (misalnya, titik pusat di Yogyakarta)
    const defaultLocationCoordinate = "-7.8589546,110.2655596"; // Koordinat diperbarui

    // Elemen HTML
    const locationSettingsTableBody = document.getElementById('locationSettingsTableBody');
    const setlokasiModalElement = document.getElementById('setlokasiModal');
    const gantiRadiusModalElement = document.getElementById('gantiRadiusModal');
    const radiusMeterInputElement = document.getElementById('radiusMeter');

    // Elemen HTML untuk Manajemen Siswa
    const studentForm = document.getElementById('studentForm');
    const studentIdInput = document.getElementById('studentId');
    const studentNameInput = document.getElementById('studentName');
    const studentClassInput = document.getElementById('studentClass');
    const studentRoomInput = document.getElementById('studentRoom');
    const addStudentButton = document.getElementById('addStudentButton');
    const updateStudentButton = document.getElementById('updateStudentButton');
    const studentErrorMsg = document.getElementById('studentErrorMsg');
    const studentTableBody = document.getElementById('studentTableBody');
    const accessDetailModal = document.getElementById('accessDetailModal');
    const accessDetailTableBody = document.getElementById('accessDetailTableBody');
    const accessDetailTokenTitle = document.getElementById('accessDetailTokenTitle');
    const examStatusFilterDropdown = document.getElementById('examStatusFilter');
    const classFilterDropdownSelect = document.getElementById('classFilterDropdownSelect');

    // Elemen HTML untuk Modal Edit Siswa
    const editStudentModal = document.getElementById('editStudentModal');
    const modalStudentIdInput = document.getElementById('modalStudentId');
    const modalStudentNameInput = document.getElementById('modalStudentName');
    const modalStudentClassInput = document.getElementById('modalStudentClass');
    const modalStudentRoomInput = document.getElementById('modalStudentRoom');
    const editStudentErrorMsg = document.getElementById('editStudentErrorMsg');

    // Elemen HTML untuk Modal Konfirmasi Penghapusan Siswa
    const deleteStudentConfirmModal = document.getElementById('deleteStudentConfirmModal');
    const emptyStudentsModal = document.getElementById('emptyStudentsModal');
    const emptyStudentsPasswordInput = document.getElementById('emptyStudentsPassword');
    const emptyStudentsPasswordError = document.getElementById('emptyStudentsPasswordError');

    // Elemen HTML untuk Modal Impor Siswa
    const importStudentModal = document.getElementById('importStudentModal');
    const csvFileInput = document.getElementById('csvFileInput');
    const importFileError = document.getElementById('importFileError');
    const importResultModal = document.getElementById('importResultModal');
    const importResultSummary = document.getElementById('importResultSummary');
    const importResultDetails = document.getElementById('importResultDetails');
    const loadingOverlay = document.getElementById('loadingOverlay');

    // Elemen HTML untuk Modal Logout
    const logoutConfirmModal = document.getElementById('logoutConfirmModal');

    // Elemen HTML untuk Modal Info Cetak Kartu
    const printInfoModal = document.getElementById('printInfoModal');

    // Tombol navigasi dan elemen header
    const sidebar = document.getElementById('sidebar');
    const loginSection = document.getElementById('loginSection');
    const dashboardContent = document.getElementById('dashboardContent');
    const tokenMenuBtn = document.getElementById('tokenMenuBtn');
    const lokasiMenuBtn = document.getElementById('lokasiMenuBtn');
    const pesertaMenuBtn = document.getElementById('pesertaMenuBtn');
    const scoreMenuBtn = document.getElementById('scoreMenuBtn'); // NEW: Score menu button
    
    // Variabel global untuk melacak status sidebar
    let isSidebarExpanded = false; // Status awal


    // BARU: Elemen input URL Google Drive dan Kunci Jawaban
    const googleDriveUrlInput = document.getElementById('googleDriveUrl');
    const googleDriveUrlError = document.getElementById('googleDriveUrlError');
    const answerKeyInput = document.getElementById('answerKey'); // Re-added
    const answerKeyCountInput = document.getElementById('answerKeyCount'); // NEW: Count input
    const answerKeyError = document.getElementById('answerKeyError'); // Re-added


    // BARU: Elemen input URL Google Drive dan Kunci Jawaban di modal edit
    const editGoogleDriveUrlInput = document.getElementById('editGoogleDriveUrl');
    const editGoogleDriveUrlError = document.getElementById('editGoogleDriveUrlError');
    const editAnswerKeyInput = document.getElementById('editAnswerKey'); // Re-added
    const editAnswerKeyCountInput = document.getElementById('editAnswerKeyCount'); // NEW: Count input
    const editAnswerKeyError = document.getElementById('editAnswerKeyError'); // Re-added

    // Elemen HTML untuk Bagian Nilai Ujian
    const scoreTableHeader = document.getElementById('scoreTableHeader');
    const scoreTableBody = document.getElementById('scoreTableBody');
    const scoreSearchNameInput = document.getElementById('scoreSearchName');
    const scoreSearchClassInput = document.getElementById('scoreSearchClass');
    
    // Elemen HTML untuk Modal Cetak/Salin Generik
    const copyPrintModal = document.getElementById('copyPrintModal');
    const copyPrintModalTitle = document.getElementById('copyPrintModalTitle');
    let currentTableIdToCopy = ''; // Variabel untuk menyimpan ID tabel yang akan disalin


    let currentScoreGradeFilter = null; // Filter untuk nilai ujian (7, 8, 9, atau null untuk semua)

    // Variabel global untuk fitur reset/submit/hapus jawaban siswa
    let studentKeyForAction = null;
    let studentIdForAction = null;
    let studentNameForAction = null;
    let studentClassForAction = null;

    // Elemen modal untuk fitur baru
    const resetStudentModal = document.getElementById('resetStudentModal');
    const resetStudentNameDisplay = document.getElementById('resetStudentNameDisplay');
    const resetStudentIdDisplay = document.getElementById('resetStudentIdDisplay');

    const submitAnswerModal = document.getElementById('submitAnswerModal');
    const submitStudentNameDisplay = document.getElementById('submitStudentNameDisplay');
    const submitStudentIdDisplay = document.getElementById('submitStudentIdDisplay');

    const deleteAnswerModal = document.getElementById('deleteAnswerModal');
    const deleteAnswerStudentNameDisplay = document.getElementById('deleteAnswerStudentNameDisplay');
    const deleteAnswerStudentIdDisplay = document.getElementById('deleteAnswerStudentIdDisplay');
    const deleteAnswerPasswordInput = document.getElementById('deleteAnswerPassword');
    const deleteAnswerPasswordError = document.getElementById('deleteAnswerPasswordError');


    // Fungsi pembantu untuk mengisi ID siswa dengan nol di depan
    function padStudentId(id) {
        return String(id).padStart(3, '0');
    }

    // Fungsi pembantu untuk mengisi nomor ruangan dengan nol di depan (2 digit)
    function padRoomNumber(room) {
        if (!room) return '-'; // Tangani ruangan kosong atau null
        // Coba konversi ke angka dan isi, jika tidak, kembalikan apa adanya
        const numRoom = parseInt(room, 10);
        if (!isNaN(numRoom)) {
            return String(numRoom).padStart(2, '0');
        }
        return String(room).toUpperCase(); // Kembalikan apa adanya jika bukan angka, pastikan huruf besar
    }

    /**
     * Fungsi pembantu untuk memformat objek Date menjadi string datetime lokal (YYYY-MM-DDTHH:mm).
     * Ini digunakan untuk menyimpan nilai input datetime-local secara konsisten tanpa masalah zona waktu.
     * @param {Date} date - Objek Date yang akan diformat.
     * @returns {string} String datetime lokal yang diformat.
     */
    function formatLocalDateTime(date) {
        const year = date.getFullYear();
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const day = date.getDate().toString().padStart(2, '0');
        const hours = date.getHours().toString().padStart(2, '0');
        const minutes = date.getMinutes().toString().padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }

    /**
     * Fungsi pembantu untuk mendapatkan kelas numerik dari string kelas (misalnya, "7A" -> "7").
     * @param {string} classString - String kelas (misalnya, "7A", "8", "9C").
     * @returns {string|null} Kelas numerik sebagai string (misalnya, "7", "8", "9") atau null jika tidak ditemukan.
     */
    function getNumericClass(classString) {
        const match = String(classString || '').match(/^(\d+)/);
        return match ? match[1] : null;
    }

    /**
     * Fungsi pembantu untuk mendapatkan instance database berdasarkan kelas.
     * @param {string} kelas - Nomor kelas (misalnya, '7', '8', '9').
     * @returns {object|null} Instance database Firebase atau null jika tidak ditemukan.
     */
    function getDbForClass(kelas) {
        const numericClass = getNumericClass(kelas);
        if (numericClass && classDbMap[numericClass]) {
            return classDbMap[numericClass];
        }
        console.error(`Instance database tidak ditemukan untuk kelas: ${kelas}`);
        return null;
    }

    // Fungsi untuk memperluas sidebar
    window.expandSidebar = () => {
        sidebar.classList.add('expanded');
        isSidebarExpanded = true;
    };

    // Fungsi untuk menyembunyikan sidebar
    window.collapseSidebar = () => {
        sidebar.classList.remove('expanded');
        isSidebarExpanded = false;
    };

    // Fungsi untuk menampilkan/menyembunyikan bagian dashboard
    window.showSection = (sectionId) => {
        // Sembunyikan semua bagian konten dashboard
        document.querySelectorAll('.dashboard-section').forEach(section => {
            section.style.display = 'none';
        });
        // Tampilkan bagian yang dipilih
        document.getElementById(sectionId).style.display = 'block';

        // Atur gaya tombol navigasi
        document.querySelectorAll('.sidebar-nav button').forEach(button => {
            button.classList.remove('active');
        });
        // Tambahkan kelas aktif ke tombol yang sesuai
        const activeBtn = document.querySelector(`.sidebar-nav button[data-section-id="${sectionId}"]`);
        if (activeBtn) {
            activeBtn.classList.add('active');
        }

        if (sectionId === 'tokenSection') {
            renderTokenTable();
        } else if (sectionId === 'locationSection') {
            updateSetlokasiStatusDisplay();
        } else if (sectionId === 'studentSection') {
            populateClassFilter();
            populateExamStatusFilter();
            renderStudentTable();
        } else if (sectionId === 'scoreSection') { // NEW: Handle score section
            renderScoreTable();
        }
    };

    // Handler utama untuk klik menu sidebar
    window.handleMenuClick = (buttonElement) => {
        const sectionId = buttonElement.dataset.sectionId;
        const action = buttonElement.dataset.action; // Untuk logout

        if (!isSidebarExpanded) {
            // Jika sidebar disembunyikan, perluas dan kemudian lakukan tindakan
            expandSidebar();
            // Gunakan sedikit penundaan untuk memungkinkan transisi CSS dimulai sebelum konten berubah
            setTimeout(() => {
                if (action === 'promptLogout') {
                    promptLogout();
                } else {
                    showSection(sectionId);
                }
            }, 100); // Sesuaikan penundaan sesuai kebutuhan untuk UX yang lebih halus
        } else {
            // Jika sidebar sudah diperluas
            if (action === 'promptLogout') {
                promptLogout();
                // Sidebar tetap diperluas untuk modal logout, akan menyembunyikan pada confirmLogout
            } else {
                const currentActiveSection = document.querySelector('.dashboard-section[style*="display: block"]');
                const currentActiveSectionId = currentActiveSection ? currentActiveSection.id : null;

                if (sectionId === currentActiveSectionId) {
                    // Mengklik bagian yang sedang aktif, tidak melakukan apa-apa (sidebar tetap diperluas)
                    console.log('Sudah di bagian ini, tidak melakukan apa-apa.');
                } else {
                    // Mengklik bagian yang berbeda, ubah konten tetapi biarkan sidebar diperluas
                    showSection(sectionId);
                }
            }
        }
    };

    // Listener klik global untuk menyembunyikan sidebar saat mengklik di luar
    document.addEventListener('click', (event) => {
        const isClickInsideSidebar = sidebar.contains(event.target);
        const isClickInsideModal = event.target.closest('.modal'); // Periksa apakah klik berada di dalam modal apa pun

        if (isSidebarExpanded && !isClickInsideSidebar && !isClickInsideModal) {
            collapseSidebar();
        }
    });


    // Fungsi untuk menampilkan notifikasi
    function showNotification(message) {
      const n = document.getElementById('notification');
      n.innerText = message;
      n.style.display = 'block';
      setTimeout(() => {
        n.style.display = 'none';
      }, 3000);
    }

    // Fungsi untuk menangani login pengguna
    window.login = () => {
      const u = document.getElementById("username").value.trim();
      const p = document.getElementById("password").value.trim();
      if(u === ADMIN_USER && p === ADMIN_PASS) {
        localStorage.setItem('isAdminLoggedIn', 'true');
        loginSection.style.display = 'none'; // Sembunyikan bagian login
        sidebar.style.display = 'flex'; // Tampilkan sidebar
        dashboardContent.style.display = 'flex'; // Tampilkan konten dashboard
        
        // Memuat data dengan listener real-time
        loadTokens(); 
        loadStudents(); 
        loadTokenAccessStatus(); 
        loadSubmittedExamsStatus(); 
        loadSetlokasiSettings(); 
        loadStudentAnswers(); // NEW: Load student answers

        showSection('tokenSection'); // Tampilkan bagian token secara default
        resetInactivityTimer(); // Mulai timer tidak aktif setelah login berhasil
        collapseSidebar(); // Pastikan sidebar disembunyikan setelah login
      } else {
        document.getElementById("loginError").innerText = "Username atau password salah.";
      }
    };

    // Fungsi untuk menampilkan modal konfirmasi logout
    window.promptLogout = () => {
        logoutConfirmModal.style.display = 'flex';
    };

    // Fungsi untuk mengkonfirmasi logout
    window.confirmLogout = () => {
      localStorage.removeItem('isAdminLoggedIn');
      dashboardContent.style.display = 'none'; // Sembunyikan konten dashboard
      sidebar.style.display = 'none'; // Sembunyikan sidebar
      loginSection.style.display = 'block'; // Tampilkan bagian login
      document.getElementById('password').value = ''; // Hapus kata sandi saat logout
      showNotification('Anda telah logout.');
      closeLogoutModal();
      collapseSidebar(); // Pastikan sidebar disembunyikan setelah logout
    };

    // Fungsi untuk menutup modal konfirmasi logout
    window.closeLogoutModal = () => {
        logoutConfirmModal.style.display = 'none';
    };

    // Fungsi untuk merender/memperbarui tabel token
    function renderTokenTable() {
        const tbody = document.getElementById('tokenTableBody');
        tbody.innerHTML = ''; // Hapus baris yang ada

        // Urutkan token berdasarkan startTime terlebih dahulu, kemudian berdasarkan kelas
        const sortedTokens = [...tokenCache].sort((a, b) => {
            const timeA = new Date(a.startTime).getTime();
            const timeB = new Date(b.startTime).getTime();
            if (timeA !== timeB) {
                return timeA - timeB;
            }

            const kelasA = String(a.kelas || '');
            const kelasB = String(b.kelas || '');

            const numKelasA = parseInt(kelasA);
            const numKelasB = parseInt(kelasB);

            if (!isNaN(numKelasA) && !isNaN(numKelasB)) {
                return numKelasA - numKelasB;
            } else {
                return kelasA.localeCompare(kelasB);
            }
        });

        let sortedCounter = 0;
        sortedTokens.forEach(data => {
            sortedCounter++;
            const row = document.createElement('tr');
            row.dataset.tokenKey = data.key;
            // Tampilkan waktu yang diformat
            const startTimeFormatted = data.startTime ? new Date(data.startTime).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) : '-';
            const endTimeFormatted = data.endTime ? new Date(data.endTime).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) : '-';
            
            let tokenDisplay = data.token;
            if (data.isForceActive) {
                tokenDisplay = `<strong style="color: #0066cc;">${data.token}</strong>`;
            } else if (data.isActive) {
                tokenDisplay = `<strong style="color: green;">${data.token}</strong>`;
            }
            let forceActiveIconsHTML = '';
            if (data.isForceActive) {
                forceActiveIconsHTML = `<img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/gembok.png" alt="Nonaktifkan Paksa" style="width: 16px; height: 16px; cursor: pointer; vertical-align: middle; margin-left: 2px;" onclick="promptForceInactive('${data.key}')">`;
            } else {
                if (data.isActive) {
                    forceActiveIconsHTML = `<img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/gembok.png" alt="Nonaktifkan Paksa" style="width: 16px; height: 16px; cursor: pointer; vertical-align: middle; margin-left: 2px;" onclick="promptForceInactive('${data.key}')">`;
                } else {
                    forceActiveIconsHTML = `<img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/kunci.png" alt="Aktifkan Paksa" style="width: 16px; height: 16px; cursor: pointer; vertical-align: middle; margin-left: 2px;" onclick="promptForceActive('${data.key}')">`;
                }
            }

            // Dapatkan jumlah siswa yang mengakses token ini
            // Catatan: tokenAccessStatus terpadu, jadi ini harus berfungsi di seluruh database
            const accessedStudents = tokenAccessStatus[data.key] ? Object.keys(tokenAccessStatus[data.key]).length : 0;

            // Hitung jumlah siswa yang telah submit untuk token ini
            // Menggunakan token.key sebagai parent node, bukan token.token
            const submittedStudentsCount = submittedExamsCache[data.key] 
                ? Object.values(submittedExamsCache[data.key]).filter(submission => submission.isSubmitted === true).length
                : 0;

            // Tampilkan kunci jawaban yang dipersingkat
            const displayAnswerKey = data.answerKey ? data.answerKey.substring(0, 10) + (data.answerKey.length > 10 ? '...' : '') : '-';

            row.innerHTML = `
                <td>${sortedCounter}</td>
                <td>${data.subject}</td>
                <td>${data.kelas}</td>
                <td><a href="#" onclick="openAccessDetailModal('${data.key}', '${data.token}')">${tokenDisplay}</a></td>
                <td>${data.googleDriveUrl ? `<a href="${data.googleDriveUrl}" target="_blank">Lihat PDF</a>` : '-'}</td>
                <td>${displayAnswerKey}</td> <td>${startTimeFormatted}</td>
                <td>${endTimeFormatted}</td>
                <td>${data.durationMinutes !== undefined ? data.durationMinutes : '-'}</td>
                <td style="text-align: center;">
                  <span style="color: ${data.isActive ? 'green' : 'grey'}; font-weight: bold;">${data.isActive ? 'ON' : 'OFF'}</span>
                  ${forceActiveIconsHTML}
                </td>
                <td style="text-align: center;">${accessedStudents}</td>
                <td style="text-align: center;">${submittedStudentsCount}</td> <td style="text-align: center;">
                  <div class="student-action-buttons">
                    <button onclick="editToken('${data.key}')">
                      <img src="${EDIT_ICON_URL}" alt="Edit">
                    </button>
                    <button onclick="promptDelete('${data.key}')">
                      <img src="${DELETE_ICON_URL}" alt="Hapus">
                    </button>
                  </div>
                </td>
            `;
            tbody.appendChild(row);
        });
        populateExamStatusFilter(); // Pastikan filter status ujian diperbarui saat token berubah
    }

    // Fungsi untuk memuat token dari semua proyek Firebase (dengan real-time listener)
    function loadTokens() {
        tokenCache = []; // Reset cache awal
        Object.keys(classDbMap).forEach(classNum => {
            const dbInstance = classDbMap[classNum];
            if (dbInstance) {
                onValue(ref(dbInstance, 'tokens'), (snapshot) => {
                    console.log(`[Real-time Update] Tokens for class ${classNum} updated.`);
                    const classTokens = [];
                    snapshot.forEach(child => {
                        const data = child.val();
                        data.key = child.key;
                        data.firebaseClass = classNum; // Simpan dari proyek Firebase mana asalnya
                        // Hapus token yang lebih lama dari 30 hari
                        if (data.createdAt && (Date.now() - data.createdAt) > THIRTY_DAYS_IN_MS) {
                            remove(ref(dbInstance, 'tokens/' + data.key))
                                .then(() => console.log(`Token ${data.key} dari kelas ${classNum} dihapus otomatis.`))
                                .catch(error => console.error(`Gagal hapus otomatis ${data.key} dari kelas ${classNum}: `, error));
                            return;
                        }
                        classTokens.push(data);
                    });

                    // Perbarui tokenCache global dengan data terbaru dari kelas ini
                    // Hapus token lama dari kelas ini, lalu tambahkan yang baru
                    tokenCache = tokenCache.filter(t => t.firebaseClass !== classNum);
                    tokenCache.push(...classTokens);
                    
                    renderTokenTable(); // Render ulang tabel setiap kali data token berubah
                    periksaAndUpdateStatusToken(); // Periksa status token juga
                }, (error) => {
                    console.error(`Error memuat token dari kelas ${classNum}:`, error);
                });
            }
        });
    }

    // Listener untuk status akses token per siswa (terpadu dari semua DB)
    function loadTokenAccessStatus() {
        tokenAccessStatus = {}; // Bersihkan cache sebelum memuat
        Object.keys(classDbMap).forEach(classNum => {
            const dbInstance = classDbMap[classNum];
            if (dbInstance) {
                onValue(ref(dbInstance, 'exam_access_status'), (snapshot) => {
                    console.log(`[Real-time Update] Exam access status for class ${classNum} updated.`);
                    const classAccessData = snapshot.val() || {};
                    // Gabungkan ke tokenAccessStatus global
                    Object.assign(tokenAccessStatus, classAccessData);
                    renderTokenTable(); // Render ulang tabel token untuk memperbarui jumlah akses
                    renderStudentTable(); // Juga perbarui tabel siswa untuk status akses
                    renderScoreTable(); // Perbarui tabel nilai juga
                }, (error) => {
                    console.error(`Error memuat exam_access_status dari kelas ${classNum}:`, error);
                });
            }
        });
    }

    // Listener untuk status pengiriman ujian per siswa (terpadu dari semua DB)
    function loadSubmittedExamsStatus() {
        submittedExamsCache = {}; // Bersihkan cache sebelum memuat
        Object.keys(classDbMap).forEach(classNum => {
            const dbInstance = classDbMap[classNum];
            if (dbInstance) {
                onValue(ref(dbInstance, 'submitted_exams'), (snapshot) => {
                    console.log(`[Real-time Update] Submitted exams for class ${classNum} updated.`);
                    const classSubmissionData = snapshot.val() || {};
                    // Gabungkan ke submittedExamsCache global
                    Object.assign(submittedExamsCache, classSubmissionData);
                    renderStudentTable(); // Render ulang tabel siswa
                    renderScoreTable(); // Perbarui tabel nilai juga
                }, (error) => {
                    console.error(`Error memuat submitted_exams dari kelas ${classNum}:`, error);
                });
            }
        });
    }

    // NEW: Listener untuk jawaban siswa (terpadu dari semua DB)
    function loadStudentAnswers() {
        studentAnswersCache = {}; // Bersihkan cache sebelum memuat
        Object.keys(classDbMap).forEach(classNum => {
            const dbInstance = classDbMap[classNum];
            if (dbInstance) {
                onValue(ref(dbInstance, 'student_answers'), (snapshot) => {
                    console.log(`[Real-time Update] Student answers for class ${classNum} updated.`);
                    const classAnswersData = snapshot.val() || {};
                    // Gabungkan ke studentAnswersCache global
                    Object.assign(studentAnswersCache, classAnswersData);
                    renderScoreTable(); // Perbarui tabel nilai
                }, (error) => {
                    console.error(`Error memuat student_answers dari kelas ${classNum}:`, error);
                });
            }
        });
    }


    /**
     * Fungsi untuk memvalidasi format kunci jawaban.
     * @param {string} key - String kunci jawaban.
     * @returns {boolean} True jika format valid, false jika tidak.
     */
    function validateAnswerKey(key) {
        if (!key) return true; // Izinkan string kosong (tidak ada kunci jawaban)
        // Regex: ^[A-D]$ or ^[A-D](,[A-D])*$
        const regex = /^[A-D](,[A-D])*$/;
        return regex.test(key);
    }

    /**
     * Fungsi untuk menghitung waktu mulai yang disesuaikan berdasarkan kelas.
     * @param {string} kelas - Kelas token (misalnya, "7", "8", "9").
     * @param {Date} originalStartTime - Objek Date dari waktu mulai asli.
     * @returns {Date} Waktu mulai yang disesuaikan.
     */
    function calculateAdjustedStartTime(kelas, originalStartTime) {
        let delaySeconds = 0;
        // Pastikan kelas adalah string dan ambil hanya digit pertama jika tersedia
        const kelasNumeric = String(kelas).trim().charAt(0);

        switch (kelasNumeric) {
            case '7':
                delaySeconds = 30; // Kelas 7 ditunda 30 detik
                break;
            case '8':
                delaySeconds = 15; // Kelas 8 ditunda 15 detik
                break;
            case '9':
                delaySeconds = 0;  // Kelas 9 tidak ada penundaan
                break;
            default:
                delaySeconds = 0; // Default tidak ada penundaan jika kelas tidak dikenali
                console.warn(`Kelas '${kelas}' tidak dikenali untuk penyesuaian waktu. Menggunakan 0 detik penundaan.`);
        }
        
        const adjustedTime = new Date(originalStartTime.getTime() + delaySeconds * 1000);
        return adjustedTime;
    }

    /**
     * Fungsi untuk mengonversi URL Google Drive dari view menjadi preview.
     * @param {string} url - URL Google Drive.
     * @returns {string} URL yang sudah dikonversi ke format preview.
     */
    function convertToPreviewLink(url) {
        if (!url || typeof url !== 'string') {
            return url;
        }
        // Ganti '/view?usp=sharing' atau '/view' dengan '/preview'
        // Ini menangani kasus umum dan juga link yang mungkin hanya '/view'
        let convertedUrl = url.replace(/\/view(\?usp=sharing)?$/, '/preview');
        return convertedUrl;
    }


    // Fungsi untuk mencatat akses tautan dan membukanya (DEMO untuk panel admin)
    window.trackAndOpenLinkDemo = async (tokenId, googleDriveUrl) => { // Mengubah pdfUrl menjadi googleDriveUrl
        const studentIdDemo = prompt("Masukkan ID Siswa untuk simulasi akses (misal: 001, 002):");
        if (!studentIdDemo) {
            showNotification("Akses dibatalkan. ID Siswa diperlukan untuk simulasi.");
            return;
        }

        const student = studentCache.find(s => s.id === padStudentId(studentIdDemo)); // Isi ID input
        if (!student) {
            showNotification(`ID Siswa '${padStudentId(studentIdDemo)}' tidak ditemukan. Harap tambahkan siswa terlebih dahulu.`);
            return;
        }

        const token = tokenCache.find(t => t.key === tokenId);
        if (!token) {
            showNotification("Token tidak ditemukan."); // Seharusnya tidak terjadi jika tokenId valid
            return;
        }

        // Ekstrak bagian numerik dari kelas siswa (misalnya, '7' dari '7A')
        const studentClassNumeric = getNumericClass(student.class);

        // Bandingkan bagian numerik dari kelas siswa dengan kelas token umum
        if (!studentClassNumeric || studentClassNumeric !== getNumericClass(token.kelas)) { // Bandingkan kelas numerik
            showNotification(`Akses ditolak: Siswa dari kelas ${student.class} tidak dapat mengakses token untuk kelas ${token.kelas}.`);
            return;
        }

        // Tentukan database target untuk status akses berdasarkan kelas token
        const targetDbForAccess = getDbForClass(token.kelas);
        if (!targetDbForAccess) {
            showNotification("Gagal mencatat akses: Database untuk kelas token tidak ditemukan.");
            return;
        }

        const tokenAccessRef = ref(targetDbForAccess, `exam_access_status/${tokenId}/${student.id}`); // Gunakan DB kelas token

        runTransaction(tokenAccessRef, (currentAccess) => {
            const now = Date.now();
            const SPAM_THRESHOLD_MS = 5000; // 5 detik

            if (currentAccess === null) {
                // Akses pertama oleh siswa ini untuk token ini
                return {
                    firstAccessTime: now,
                    lastAccessTime: now,
                    accessCount: 1,
                    isLoggedIn: true // Set isLoggedIn true on first access
                };
            } else {
                // Akses berikutnya oleh siswa ini untuk token ini
                if (now - (currentAccess.lastAccessTime || 0) > SPAM_THRESHOLD_MS) { // Pastikan lastAccessTime ada
                    // Bukan klik spam, tingkatkan hitungan
                    currentAccess.accessCount = (currentAccess.accessCount || 0) + 1;
                    currentAccess.lastAccessTime = now;
                } else {
                    // Klik spam, hanya perbarui lastAccessTime tetapi jangan tingkatkan hitungan
                    currentAccess.lastAccessTime = now;
                }
                currentAccess.isLoggedIn = true; // Ensure isLoggedIn is true on subsequent access
                return currentAccess;
            }
        })
        .then(() => {
            console.log(`Akses token ${tokenId} oleh siswa ${student.id} berhasil dicatat di DB kelas ${getNumericClass(token.kelas)}.`);
            showNotification(`Siswa ${student.id} dari kelas ${student.class} berhasil mengakses token ${token.token} (kelas ${token.kelas}).`);
            window.open(googleDriveUrl, '_blank'); // Buka URL Google Drive
        })
        .catch(error => {
            console.error("Gagal mencatat akses token:", error);
            showNotification('Gagal mencatat akses token, namun ujian akan tetap dibuka.');
            window.open(googleDriveUrl, '_blank'); // Tetap buka URL Google Drive meskipun perekaman gagal
        });
    };


    // Event listener untuk pengiriman formulir token
    document.getElementById('tokenForm').addEventListener('submit', async function(e) { // Jadikan async
      e.preventDefault();
      const s = document.getElementById('subject').value.trim().toUpperCase();
      const k = document.getElementById('kelas').value.trim(); // Dapatkan kelas sebagai string (misalnya, "7", "8", "9")
      const t = document.getElementById('token').value.trim().toUpperCase(); // Ini adalah token dasar
      const originalGoogleDriveUrl = googleDriveUrlInput.value.trim(); // Simpan URL asli
      const googleDriveUrlPreview = convertToPreviewLink(originalGoogleDriveUrl); // Konversi ke link preview
      const answerKey = answerKeyInput.value.trim().toUpperCase(); // Re-added
      const startTimeInput = document.getElementById('startTime').value; // Dapatkan string waktu mulai secara langsung
      const endTimeInput = document.getElementById('endTime').value; // Dapatkan string waktu akhir secara langsung
      const em= document.getElementById('errorMsg');
      em.innerText = "";
      googleDriveUrlError.innerText = ""; // Hapus kesalahan URL Google Drive
      answerKeyError.innerText = ""; // Re-added

      // Tentukan database target berdasarkan kelas
      const targetDb = getDbForClass(k);
      if (!targetDb) {
          em.innerText = "Kelas tidak valid atau konfigurasi Firebase belum lengkap untuk kelas ini (harus 7, 8, atau 9).";
          return;
      }

      if (!s || !k || !t || !originalGoogleDriveUrl || !answerKey || !startTimeInput || !endTimeInput) { // answerKey re-added to validation
        em.innerText = "Semua field harus diisi!";
        return;
      }

      const originalStartTime = new Date(startTimeInput); // Parse sebagai waktu lokal
      const originalEndTime = new Date(endTimeInput); // Parse sebagai waktu lokal

      if (originalStartTime >= originalEndTime) {
        em.innerText = "Waktu token dibuka harus sebelum waktu token ditutup!";
        return;
      }

      if (!validateAnswerKey(answerKey)) { // Re-added
          answerKeyError.innerText = "Format kunci jawaban tidak valid. Gunakan A,B,C,D dipisah koma (contoh: A,B,C,D,D).";
          return;
      }

      // Validasi URL dasar untuk tautan Google Drive
      if (!originalGoogleDriveUrl.startsWith('http')) {
          googleDriveUrlError.innerText = "URL Google Drive tidak valid.";
          return;
      }

      // Periksa token dasar duplikat hanya dalam database target
      const isTokenDup = tokenCache.some(item => item.token === t && getNumericClass(item.kelas) === getNumericClass(k));
      if (isTokenDup) {
        em.innerText = "Token (Base Token) sudah ada untuk kelas ini!";
        return;
      }

      loadingOverlay.style.display = 'flex'; // Tampilkan loading

      // Hitung waktu mulai yang disesuaikan
      const adjustedStartTime = calculateAdjustedStartTime(k, originalStartTime);
      // Hitung durasi dalam menit
      const durationMinutes = Math.round((originalEndTime.getTime() - adjustedStartTime.getTime()) / (1000 * 60));

      const data = {
          subject: s,
          kelas: k, // Simpan kelas sesuai yang diberikan (misalnya, "7", "8", "9")
          token: t,
          googleDriveUrl: googleDriveUrlPreview, // Simpan link preview
          originalGoogleDriveUrl: originalGoogleDriveUrl, // Simpan link asli
          answerKey: answerKey, // Re-added
          startTime: formatLocalDateTime(adjustedStartTime), // Simpan waktu yang disesuaikan dalam format lokal
          endTime: endTimeInput, // Simpan waktu akhir apa adanya (format lokal)
          durationMinutes: durationMinutes, // Simpan durasi
          createdAt: Date.now(),
          isActive: false,
          isForceActive: false
      };

      push(ref(targetDb, 'tokens'), data) // Dorong ke database kelas tertentu
        .then(() => {
          this.reset();
          googleDriveUrlError.innerText = ''; // Hapus kesalahan URL Google Drive
          answerKeyInput.value = ''; // Clear answer key input
          answerKeyCountInput.value = '0'; // Reset count
          answerKeyError.innerText = ''; // Re-added
          showNotification('Token berhasil ditambahkan! Status akan otomatis aktif sesuai waktu.');
        })
        .catch(err => {
          em.innerText = "Gagal menyimpan token: " + err.message;
        })
        .finally(() => {
          loadingOverlay.style.display = 'none';
        });
    });

    // Fungsi untuk membuka modal edit token
    window.editToken = (id) => {
      const token = tokenCache.find(item => item.key === id);
      if (!token) return;

      currentTokenId = id;
      document.getElementById('editSubject').value = token.subject;
      document.getElementById('editKelas').value = token.kelas;
      document.getElementById('editToken').value = token.token;
      
      // Atur URL Google Drive: Gunakan originalGoogleDriveUrl jika ada, jika tidak gunakan googleDriveUrl (untuk kompatibilitas mundur)
      editGoogleDriveUrlInput.value = token.originalGoogleDriveUrl || token.googleDriveUrl || '';
      editGoogleDriveUrlError.innerText = ''; // Hapus kesalahan

      // Atur kunci jawaban (Re-added)
      editAnswerKeyInput.value = token.answerKey || '';
      updateAnswerKeyCount(editAnswerKeyInput, editAnswerKeyCountInput); // Update count for edit modal
      editAnswerKeyError.innerText = ''; // Hapus kesalahan

      // Atur nilai langsung dari string yang disimpan (yang dalam format datetime lokal)
      document.getElementById('editStartTime').value = token.startTime;
      document.getElementById('editEndTime').value = token.endTime;
      document.getElementById('editErrorMsg').innerText = "";
      document.getElementById('editModal').style.display = 'flex';
    };

    // Event listener untuk pengiriman formulir modal (edit token)
    document.getElementById('modalForm').addEventListener('submit', async function(e) { // Jadikan async
      e.preventDefault();
      const s = document.getElementById('editSubject').value.trim().toUpperCase();
      const newKelas = document.getElementById('editKelas').value.trim(); // Kelas baru
      const t = document.getElementById('editToken').value.trim().toUpperCase();
      const originalGoogleDriveUrl = editGoogleDriveUrlInput.value.trim(); // Simpan URL asli dari input edit
      const googleDriveUrlPreview = convertToPreviewLink(originalGoogleDriveUrl); // Konversi ke link preview
      const answerKey = editAnswerKeyInput.value.trim().toUpperCase(); // Re-added
      const startTimeInput = document.getElementById('editStartTime').value;
      const endTimeInput = document.getElementById('editEndTime').value;
      const em = document.getElementById('editErrorMsg');
      em.innerText = "";
      editGoogleDriveUrlError.innerText = "";
      editAnswerKeyError.innerText = ""; // Re-added

      // Temukan data token asli untuk mendapatkan kelas aslinya
      const originalTokenData = tokenCache.find(item => item.key === currentTokenId);
      if (!originalTokenData) {
          em.innerText = "Token asli tidak ditemukan.";
          return;
      }
      const oldKelas = originalTokenData.kelas;
      const oldDb = getDbForClass(oldKelas);
      const newDb = getDbForClass(newKelas);

      if (!oldDb || !newDb) {
          em.innerText = "Kelas tidak valid atau konfigurasi Firebase belum lengkap untuk kelas ini (harus 7, 8, atau 9).";
          return;
      }

      if (!s || !newKelas || !t || !originalGoogleDriveUrl || !answerKey || !startTimeInput || !endTimeInput) { // answerKey re-added
        em.innerText = "Semua field harus diisi!";
        return;
      }

      const originalStartTime = new Date(startTimeInput);
      const originalEndTime = new Date(endTimeInput);

      if (originalStartTime >= originalEndTime) {
        em.innerText = "Waktu token dibuka harus sebelum waktu token ditutup!";
        return;
      }

      if (!validateAnswerKey(answerKey)) { // Re-added
          editAnswerKeyError.innerText = "Format kunci jawaban tidak valid. Gunakan A,B,C,D dipisah koma (contoh: A,B,C,D,D).";
          return;
      }

      if (!originalGoogleDriveUrl.startsWith('http')) {
          editGoogleDriveUrlError.innerText = "URL Google Drive tidak valid.";
          return;
      }

      // Periksa token dasar duplikat hanya dalam database target (jika kelas berubah)
      // Atau dalam database yang sama (jika kelas tidak berubah)
      const isTokenDup = tokenCache.some(item => 
          item.token === t && 
          item.key !== currentTokenId && // Kecualikan token yang sedang diedit
          getNumericClass(item.kelas) === getNumericClass(newKelas) // Periksa terhadap nilai numerik kelas baru
      );
      if (isTokenDup) {
        em.innerText = "Token (Base Token) sudah ada untuk kelas ini!";
        return;
      }

      loadingOverlay.style.display = 'flex'; // Tampilkan loading

      const adjustedStartTime = calculateAdjustedStartTime(newKelas, originalStartTime);
      const durationMinutes = Math.round((originalEndTime.getTime() - adjustedStartTime.getTime()) / (1000 * 60));

      const updatedData = {
          subject: s,
          kelas: newKelas,
          token: t,
          googleDriveUrl: googleDriveUrlPreview, // Simpan link preview
          originalGoogleDriveUrl: originalGoogleDriveUrl, // Simpan link asli
          answerKey: answerKey, // Re-added
          startTime: formatLocalDateTime(adjustedStartTime),
          endTime: endTimeInput,
          durationMinutes: durationMinutes,
          createdAt: originalTokenData.createdAt // Pertahankan waktu pembuatan asli
      };

      try {
          if (getNumericClass(oldKelas) !== getNumericClass(newKelas)) {
              // Kelas telah berubah, lakukan operasi "pindah"
              console.log(`Token ${currentTokenId} dipindahkan dari kelas ${oldKelas} ke kelas ${newKelas}.`);

              // 1. Hapus token dari database lama
              await remove(ref(oldDb, 'tokens/' + currentTokenId));
              console.log(`Token ${currentTokenId} dihapus dari DB kelas ${oldKelas}.`);

              // 2. Hapus status akses terkait dari database lama (menggunakan token.key)
              await remove(ref(oldDb, `exam_access_status/${currentTokenId}`));
              console.log(`exam_access_status untuk token ${currentTokenId} dihapus dari DB kelas ${oldKelas}.`);

              // 3. Hapus status ujian yang dikirim terkait dari database lama (menggunakan token.key)
              await remove(ref(oldDb, `submitted_exams/${currentTokenId}`)); 
              console.log(`submitted_exams untuk token ${currentTokenId} dihapus dari DB kelas ${oldKelas}.`);

              // 4. Hapus jawaban siswa terkait dari database lama (menggunakan token.key)
              await remove(ref(oldDb, `student_answers/${currentTokenId}`)); 
              console.log(`student_answers untuk token ${currentTokenId} dihapus dari DB kelas ${oldKelas}.`);

              // 5. Tambahkan token ke database baru
              await push(ref(newDb, 'tokens'), updatedData);
              showNotification(`Token berhasil dipindahkan ke kelas ${newKelas}! Riwayat akses/pengiriman token di kelas lama telah direset.`);
          } else {
              // Kelas tidak berubah, cukup perbarui di database yang sama
              await update(ref(newDb, 'tokens/' + currentTokenId), updatedData);
              showNotification('Token berhasil diedit!');
          }
          closeEditModal();
      } catch (err) {
          em.innerText = "Gagal menyimpan perubahan token: " + err.message;
          console.error("Error saving token changes:", err);
      } finally {
          loadingOverlay.style.display = 'none';
        }
    });

    // Fungsi untuk menutup modal edit token
    window.closeEditModal = () => {
      document.getElementById('editModal').style.display = 'none';
      document.getElementById('editErrorMsg').innerText = "";
      editGoogleDriveUrlError.innerText = ""; // Hapus kesalahan URL Google Drive
      editAnswerKeyError.innerText = ""; // Re-added
      currentTokenId = null;
    };

    let deleteId = null;
    // Fungsi untuk menampilkan konfirmasi penghapusan token
    window.promptDelete = (id) => {
      deleteId = id;
      document.getElementById('deleteModal').style.display = 'flex';
    };

    // Fungsi untuk mengkonfirmasi penghapusan token
    window.confirmDelete = async () => { // Jadikan async
      if (deleteId) {
        const tokenDataToDelete = tokenCache.find(t => t.key === deleteId);
        if (!tokenDataToDelete) {
            showNotification("Token tidak ditemukan.");
            closeDeleteModal();
            return;
        }

        const targetDb = getDbForClass(tokenDataToDelete.kelas); // Dapatkan db berdasarkan kelas token
        if (!targetDb) {
            showNotification("Gagal menghapus: Database untuk kelas token tidak ditemukan.");
            closeDeleteModal();
            return;
        }

        loadingOverlay.style.display = 'flex'; // Tampilkan loading

        try {
            // Hapus entri Realtime Database dari database spesifiknya
            await remove(ref(targetDb, 'tokens/' + deleteId));

            // Juga hapus status akses terkait untuk token ini (dari database spesifiknya)
            await remove(ref(targetDb, `exam_access_status/${deleteId}`));
            // Juga hapus status pengiriman terkait untuk token ini menggunakan token.key (dari database spesifiknya)
            await remove(ref(targetDb, `submitted_exams/${deleteId}`));
            // NEW: Hapus jawaban siswa terkait untuk token ini menggunakan token.key (dari database spesifiknya)
            await remove(ref(targetDb, `student_answers/${deleteId}`));
            showNotification('Token berhasil dihapus!');
        } catch (err) {
            console.error("Gagal menghapus token:", err); // Pesan disesuaikan
            showNotification("Gagal menghapus token: " + err.message);
        } finally {
            loadingOverlay.style.display = 'none'; // Sembunyikan loading
            closeDeleteModal();
        }
      }
    };

    // Fungsi untuk menutup modal penghapusan token
    window.closeDeleteModal = () => {
      document.getElementById('deleteModal').style.display = 'none';
      deleteId = null;
    };

    // Opsional: Tutup modal saat mengklik di luar konten modal
    window.onclick = function(event) {
        // Hanya tutup jika klik berada di latar belakang modal itu sendiri, bukan kontennya
        if (event.target == printInfoModal) {
            printInfoModal.style.display = 'none';
        }
        if (event.target == editModal) {
            closeEditModal();
        }
        if (event.target == deleteModal) {
            closeDeleteModal();
        }
        if (event.target == forceActiveModal) {
            closeForceActiveModal();
        }
        if (event.target == forceInactiveModal) {
            closeForceInactiveModal();
        }
        if (event.target == copyPrintModal) { // Handle generic print modal
            closeCopyPrintModal();
        }
        if (event.target == setlokasiModalElement) {
            closeSetlokasiModal();
        }
        if (event.target == gantiRadiusModalElement) {
            closeGantiRadiusModal();
        }
        if (event.target == accessDetailModal) {
            closeAccessDetailModal();
        }
        if (event.target == editStudentModal) {
            closeEditStudentModal();
        }
        if (event.target == deleteStudentConfirmModal) {
            closeDeleteStudentConfirmModal();
        }
        if (event.target == importStudentModal) {
            closeImportStudentModal();
        }
        if (event.target == importResultModal) {
            closeImportResultModal();
        }
        if (event.target == emptyStudentsModal) {
            closeEmptyStudentsModal();
        }
        if (event.target == logoutConfirmModal) {
            closeLogoutModal();
        }
        // New modals for student actions
        if (event.target == resetStudentModal) {
            closeResetStudentModal();
        }
        if (event.target == submitAnswerModal) {
            closeSubmitAnswerModal();
        }
        if (event.target == deleteAnswerModal) {
            closeDeleteAnswerModal();
        }
    };

    // Fungsi untuk menampilkan konfirmasi token paksa aktif
    window.promptForceActive = (tokenId) => {
      currentForceActiveTokenId = tokenId;
      document.getElementById('forceActivePassword').value = ''; // Bersihkan kata sandi sebelumnya
      document.getElementById('forceActivePasswordError').innerText = ''; // Bersihkan pesan kesalahan sebelumnya
      document.getElementById('forceActiveModal').style.display = 'flex';
    };

    // Fungsi untuk menampilkan konfirmasi token paksa tidak aktif
    window.promptForceInactive = (tokenId) => {
      currentForceActiveTokenId = tokenId;
      document.getElementById('forceInactiveModal').style.display = 'flex';
    };

    // Fungsi untuk mengkonfirmasi token paksa aktif
    window.confirmForceActive = () => {
      const password = document.getElementById('forceActivePassword').value;
      const passwordError = document.getElementById('forceActivePasswordError');

      if (password !== ADMIN_PASS) {
        passwordError.innerText = "Password salah!";
        return;
      }

      const tokenData = tokenCache.find(t => t.key === currentForceActiveTokenId);
      if (!tokenData) {
          showNotification("Token tidak ditemukan.");
          closeForceActiveModal();
          return;
      }
      const targetDb = getDbForClass(tokenData.kelas);
      if (!targetDb) {
          showNotification("Gagal mengaktifkan: Database untuk kelas token tidak ditemukan.");
          closeForceActiveModal();
          return;
      }

      if (currentForceActiveTokenId) {
        update(ref(targetDb, 'tokens/' + currentForceActiveTokenId), { isForceActive: true, isActive: true })
          .then(() => {
            showNotification('Token dipaksa aktif!');
            // Render ulang tabel akan ditangani oleh listener onValue untuk 'tokens'
          })
          .catch(error => {
            console.error("Gagal mengaktifkan status paksa: ", error);
            showNotification("Gagal mengaktifkan status paksa.");
          })
          .finally(() => {
            closeForceActiveModal();
            currentForceActiveTokenId = null;
          });
      } else {
        closeForceActiveModal();
        currentForceActiveTokenId = null;
      }
    };

    // Fungsi untuk menutup modal paksa aktif
    window.closeForceActiveModal = () => {
      document.getElementById('forceActiveModal').style.display = 'none';
      document.getElementById('forceActivePassword').value = '';
      document.getElementById('forceActivePasswordError').innerText = '';
      currentForceActiveTokenId = null;
    };

    // Fungsi untuk mengkonfirmasi token paksa tidak aktif
    window.confirmForceInactive = () => {
      const tokenData = tokenCache.find(t => t.key === currentForceActiveTokenId);
      if (!tokenData) {
          showNotification("Token tidak ditemukan.");
          closeForceInactiveModal();
          return;
      }
      const targetDb = getDbForClass(tokenData.kelas);
      if (!targetDb) {
          showNotification("Gagal menonaktifkan: Database untuk kelas token tidak ditemukan.");
          closeForceInactiveModal();
          return;
      }

      if (currentForceActiveTokenId) {
        update(ref(targetDb, 'tokens/' + currentForceActiveTokenId), { isForceActive: false })
          .then(() => {
            showNotification('Token paksa aktif dinonaktifkan!');
            // Render ulang tabel akan ditangani oleh listener onValue untuk 'tokens'
          })
          .catch(error => {
            console.error("Gagal menonaktifkan status paksa: ", error);
            showNotification("Gagal menonaktifkan token paksa.");
          })
          .finally(() => {
            closeForceInactiveModal();
            currentForceActiveTokenId = null;
          });
      }
    };

    // Fungsi untuk menutup modal paksa tidak aktif
    window.closeForceInactiveModal = () => {
      document.getElementById('forceInactiveModal').style.display = 'none';
      currentForceActiveTokenId = null;
    };

    // Fungsi untuk memeriksa dan memperbarui status token di semua database
    async function periksaAndUpdateStatusToken() {
      const now = new Date();
      for (const tokenData of tokenCache) {
        let newIsActive;
        if (tokenData.isForceActive) {
          newIsActive = true; // Jika dipaksa aktif, selalu aktif
        } else {
          const startTime = new Date(tokenData.startTime);
          const endTime = new Date(tokenData.endTime);
          newIsActive = now >= startTime && now < endTime;
        }

        if (tokenData.isActive !== newIsActive) {
          const targetDb = getDbForClass(tokenData.kelas);
          if (targetDb) {
            try {
              await update(ref(targetDb, 'tokens/' + tokenData.key), { isActive: newIsActive });
              console.log(`Token ${tokenData.key} dari kelas ${tokenData.kelas} status diperbarui menjadi ${newIsActive ? 'aktif' : 'nonaktif'}.`);
              // Render ulang tabel akan ditangani oleh listener onValue untuk 'tokens'
            } catch (error) {
              console.error(`Gagal memperbarui status token ${tokenData.key} dari kelas ${tokenData.kelas}: `, error);
            }
          } else {
            console.warn(`Tidak dapat menemukan database untuk token ${tokenData.key} (kelas ${tokenData.kelas}) untuk memperbarui status.`);
          }
        }
      }
    }

    // Fungsi untuk memperbarui tampilan waktu saat ini
    function updateTime() {
      const now = new Date();
      const dateOptions = { weekday: 'long', day: '2-digit', month: 'long', year: 'numeric' };
      const timeOptions = { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false };
      const tanggal = now.toLocaleDateString('id-ID', dateOptions);
      const waktu = now.toLocaleTimeString('id-ID', timeOptions).replace(/\./g, ':');
      const display = `${tanggal} pukul ${waktu}`;
      const ct = document.getElementById("currentTime");
      if (ct) ct.innerText = display;
      const adt = document.getElementById("adminDateTime");
      if (adt) adt.innerText = display;
    }

    setInterval(updateTime, 1000);
    updateTime();

    // Fungsi untuk mereset timer tidak aktif
    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(logoutDueToInactivity, INACTIVITY_TIMEOUT);
    }

    // Fungsi untuk menangani logout karena tidak aktif
    function logoutDueToInactivity() {
      localStorage.removeItem('isAdminLoggedIn');
      dashboardContent.style.display = 'none';
      sidebar.style.display = 'none';
      loginSection.style.display = 'block';
      document.getElementById('password').value = '';
      showNotification('Anda telah logout karena tidak ada aktivitas, masukan password kembali!.');
    }

    // Event listener untuk aktivitas pengguna untuk mereset timer tidak aktif
    window.addEventListener('mousemove', resetInactivityTimer);
    window.addEventListener('keypress', resetInactivityTimer);
    window.addEventListener('scroll', resetInactivityTimer);
    window.addEventListener('click', resetInactivityTimer);

    // Logika pemuatan halaman awal
    window.onload = function() {
      if (localStorage.getItem('isAdminLoggedIn') === 'true') {
        loginSection.style.display = 'none';
        sidebar.style.display = 'flex'; // Tampilkan sidebar saat dimuat jika sudah login
        dashboardContent.style.display = 'flex';
        
        // Memuat data dengan listener real-time
        loadTokens(); 
        loadStudents(); 
        loadTokenAccessStatus(); 
        loadSubmittedExamsStatus(); 
        loadSetlokasiSettings(); 
        loadStudentAnswers(); // NEW: Load student answers

        showSection('tokenSection'); // Tampilkan bagian token secara default
        resetInactivityTimer();
        collapseSidebar(); // Pastikan sidebar disembunyikan setelah login
      } else {
        loginSection.style.display = 'block';
        sidebar.style.display = 'none'; // Sembunyikan sidebar jika belum login
        dashboardContent.style.display = 'none';
        collapseSidebar(); // Pastikan sidebar disembunyikan di halaman login
      }
    };

    let statusCheckInterval;
    statusCheckInterval = setInterval(periksaAndUpdateStatusToken, 10000);

    // Fungsi untuk memperbarui tampilan tabel pengaturan lokasi
    function updateSetlokasiStatusDisplay() {
      locationSettingsTableBody.innerHTML = ''; // Hapus baris yang ada
      const row = document.createElement('tr');
      const statusText = isLocationEnabledAdmin ? 'ON' : 'OFF';
      const statusColor = isLocationEnabledAdmin ? 'green' : 'red';

      row.innerHTML = `
        <td><a href="http://maps.google.com/?q=$$$$$$${defaultLocationCoordinate}" target="_blank">${defaultLocationCoordinate}</a></td>
        <td>${allowedRadiusMeterAdmin}m</td>
        <td style="color: ${statusColor}; font-weight: bold;">${statusText}</td>
        <td>
          <button class="icon-button" onclick="openSetlokasiModal()">
            <img src="https://raw.githubusercontent.com/smp2pajangan/gambar/refs/heads/main/lokasi.png" alt="Setlokasi">
          </button>
        </td>
      `;
      locationSettingsTableBody.appendChild(row);
    }

    // Fungsi untuk membuka modal pengaturan lokasi
    window.openSetlokasiModal = () => {
      setlokasiModalElement.style.display = 'flex';
    };

    // Fungsi untuk menutup modal pengaturan lokasi
    window.closeSetlokasiModal = () => {
      setlokasiModalElement.style.display = 'none';
    };

    // Fungsi untuk membuka modal ganti radius
    window.openGantiRadiusModal = () => {
      gantiRadiusModalElement.style.display = 'flex';
      radiusMeterInputElement.value = allowedRadiusMeterAdmin;
      closeSetlokasiModal();
    };

    // Fungsi untuk menutup modal ganti radius
    window.closeGantiRadiusModal = () => {
      gantiRadiusModalElement.style.display = 'none';
    };

    // Fungsi untuk mengaktifkan fitur lokasi (menggunakan db7 sebagai utama)
    window.aktifkanLokasi = () => {
      update(settingsRef, { isLocationEnabled: true })
        .then(() => {
          isLocationEnabledAdmin = true;
          updateSetlokasiStatusDisplay();
          showNotification('Fitur lokasi berhasil diaktifkan.');
          closeSetlokasiModal();
        })
        .catch(error => {
          console.error("Gagal mengaktifkan lokasi:", error);
          showNotification('Gagal mengaktifkan fitur lokasi.');
        });
    };

    // Fungsi untuk menonaktifkan fitur lokasi (menggunakan db7 sebagai utama)
    window.nonaktifkanLokasi = () => {
      update(settingsRef, { isLocationEnabled: false })
        .then(() => {
          isLocationEnabledAdmin = false;
          updateSetlokasiStatusDisplay();
          showNotification('Fitur lokasi berhasil dinonaktifkan.');
          closeSetlokasiModal();
        })
        .catch(error => {
          console.error("Gagal menonaktifkan lokasi:", error);
          showNotification('Gagal menonaktifkan fitur lokasi.');
        });
    };

    // Fungsi untuk mengubah radius dan mengaktifkan lokasi (menggunakan db7 sebagai utama)
    window.gantiRadiusDanAktifkan = () => {
      const radiusMeter = parseInt(radiusMeterInputElement.value);
      if (isNaN(radiusMeter) || radiusMeter <= 0) {
        showNotification('Masukkan radius yang valid dalam meter.');
        return;
      }
      const radiusKm = radiusMeter / 1000;

      update(settingsRef, { allowedRadiusKm: radiusKm, isLocationEnabled: true })
        .then(() => {
          allowedRadiusMeterAdmin = radiusMeter;
          isLocationEnabledAdmin = true;
          updateSetlokasiStatusDisplay();
          showNotification(`Radius lokasi diubah menjadi ${radiusMeter} meter dan fitur lokasi diaktifkan.`);
          closeGantiRadiusModal();
        })
        .catch(error => {
          console.error("Gagal mengganti radius:", error);
          showNotification('Gagal mengganti radius lokasi.');
        });
    };

    // Fungsi untuk memuat pengaturan lokasi dari Firebase (menggunakan db7 sebagai utama)
    function loadSetlokasiSettings() {
      onValue(settingsRef, (snapshot) => {
        const settings = snapshot.val();
        if (settings) {
          isLocationEnabledAdmin = settings.isLocationEnabled !== undefined ? settings.isLocationEnabled : true;
          allowedRadiusMeterAdmin = (settings.allowedRadiusKm !== undefined ? settings.allowedRadiusKm : 0.075) * 1000;
          updateSetlokasiStatusDisplay();
        } else {
          // Jika node 'setlokasi' tidak ada, inisialisasi dengan nilai default
          updateSetlokasiStatusDisplay();
        }
      });
    }

    // Fungsi untuk membuka modal detail akses token
    window.openAccessDetailModal = async (tokenId, tokenValue) => {
        accessDetailTokenTitle.innerText = `Detail Akses Token: ${tokenValue}`;
        accessDetailTableBody.innerHTML = '<tr><td colspan="6">Memuat data...</td></tr>';
        accessDetailModal.style.display = 'flex';

        const tokenData = tokenCache.find(t => t.key === tokenId);
        if (!tokenData) {
            accessDetailTableBody.innerHTML = '<tr><td colspan="6" style="color: red;">Token tidak ditemukan.</td></tr>';
            return;
        }

        const targetDb = getDbForClass(tokenData.kelas);
        if (!targetDb) {
            accessDetailTableBody.innerHTML = '<tr><td colspan="6" style="color: red;">Database untuk kelas token tidak ditemukan.</td></tr>';
            return;
        }

        try {
            // Status akses disimpan di database spesifik token
            const accessSnapshot = await get(ref(targetDb, `exam_access_status/${tokenId}`));
            const accessData = accessSnapshot.val();

            accessDetailTableBody.innerHTML = ''; // Hapus pesan loading

            if (accessData) {
                let counter = 0;
                // Urutkan data akses berdasarkan ID siswa untuk tampilan yang konsisten
                const sortedStudentIds = Object.keys(accessData).sort((a, b) => a.localeCompare(b));

                for (const studentId of sortedStudentIds) {
                    counter++;
                    const studentInfo = studentCache.find(s => s.id === studentId); // Temukan info siswa dari cache terpadu
                    // Dapatkan data pengiriman menggunakan token.key (bukan token.token)
                    const studentSubmissionData = submittedExamsCache[tokenId] && submittedExamsCache[tokenId][studentId]; 
                    
                    const studentName = studentInfo ? studentInfo.name : 'Tidak Ditemukan';
                    const studentClass = studentInfo ? studentInfo.class : 'Tidak Ditemukan';
                    const firstAccessTime = accessData[studentId].firstAccessTime ? new Date(accessData[studentId].firstAccessTime).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' }) : '-';
                    const accessCount = accessData[studentId].accessCount || 0;
                    const isLoggedIn = accessData[studentId].isLoggedIn === true; // Ambil status isLoggedIn
                    const isSubmitted = studentSubmissionData && studentSubmissionData.isSubmitted === true; // Periksa status pengiriman

                    let displayStatus = 'Belum Mengakses';
                    let statusColor = '';
                    if (isSubmitted) { // Prioritaskan status pengiriman
                        displayStatus = 'Sudah submit';
                        statusColor = 'green'; // Atur warna untuk status dikirim
                    } else if (isLoggedIn) { // Jika sedang login
                        if (accessCount > 0) {
                            displayStatus = `Sedang mengerjakan (${accessCount})`;
                            statusColor = 'orange'; // Kuning/Oranye
                        } else {
                            displayStatus = 'Sedang mengerjakan'; // Login tapi belum ada aksesCount
                            statusColor = 'orange';
                        }
                    } else if (accessCount > 0) { // Tidak login tapi pernah akses
                        displayStatus = 'Belum login (reset)'; // Ini berarti pernah login, tapi direset
                        statusColor = 'purple';
                    } else { // Tidak login dan belum pernah akses
                        displayStatus = 'Belum login';
                        statusColor = 'red';
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${counter}</td>
                        <td>${studentId}</td>
                        <td>${studentName}</td>
                        <td>${studentClass}</td>
                        <td style="color: ${statusColor}; font-weight: bold;">${displayStatus}</td>
                        <td>${firstAccessTime}</td>
                    `;
                    accessDetailTableBody.appendChild(row);
                }
            } else {
                accessDetailTableBody.innerHTML = '<tr><td colspan="6">Tidak ada data akses untuk token ini.</td></tr>';
            }
        } catch (error) {
            console.error("Error memuat detail akses:", error);
            accessDetailTableBody.innerHTML = '<tr><td colspan="6" style="color: red;">Gagal memuat detail akses.</td></tr>';
        }
    };

    // Fungsi untuk menutup modal detail akses token
    window.closeAccessDetailModal = () => {
        accessDetailModal.style.display = 'none';
        accessDetailTableBody.innerHTML = '';
    };

    /* --- Fungsi Manajemen Siswa --- */

    // Fungsi pembantu untuk mengekstrak bagian numerik dan abjad untuk penyortiran kelas
    const extractClassParts = (className) => {
        const match = className.match(/^(\d+)([A-Z]+)?$/);
        if (match) {
            return { num: parseInt(match[1]), char: match[2] || '' }; // Tangani kasus seperti '7' tanpa karakter rombel
        }
        return { num: 0, char: String(className || '') }; // Fallback untuk format yang tidak terduga, pastikan string
    };

    // Fungsi untuk merender/memperbarui tabel siswa
    async function renderStudentTable() {
        studentTableBody.innerHTML = '';
        let counter = 0;
        const now = new Date();

        let studentsToDisplay = studentCache;

        // Terapkan filter kelas terlebih dahulu
        if (currentStudentClassFilter) {
            if (currentStudentClassFilter.endsWith('_all')) {
                const classPrefix = currentStudentClassFilter.split('_')[0];
                studentsToDisplay = studentsToDisplay.filter(student => String(student.class || '').startsWith(classPrefix));
            } else {
                studentsToDisplay = studentsToDisplay.filter(student => String(student.class || '') === currentStudentClassFilter);
            }
        }

        let selectedTokenForStatus = null;
        if (currentExamStatusFilterToken) {
            selectedTokenForStatus = tokenCache.find(t => t.key === currentExamStatusFilterToken);
            if (selectedTokenForStatus) {
                const tokenClassNumeric = getNumericClass(selectedTokenForStatus.kelas); 
                // Filter siswa lebih lanjut hanya untuk siswa yang kelasnya dimulai dengan kelas token
                studentsToDisplay = studentsToDisplay.filter(student => getNumericClass(student.class) === tokenClassNumeric);
            } else {
                // Token tidak ditemukan, mungkin dihapus? Bersihkan filter internal tetapi pertahankan pilihan visual
                currentExamStatusFilterToken = null; // Bersihkan filter internal
                showNotification("Token ujian yang dipilih tidak ditemukan atau telah dihapus. Menampilkan status saat ini.");
            }
        }

        // Logika penyortiran
        studentsToDisplay.sort((a, b) => {
            // Urutan utama: Berdasarkan status akses (Tidak Diakses/Tidak Aktif diprioritaskan)
            // HANYA JIKA token tertentu dipilih dalam filter status ujian
            if (currentExamStatusFilterToken) {
                let isAccessedA = (tokenAccessStatus[currentExamStatusFilterToken] && tokenAccessStatus[currentExamStatusFilterToken][a.id] && (tokenAccessStatus[currentExamStatusFilterToken][a.id].accessCount || 0) > 0);
                let isAccessedB = (tokenAccessStatus[currentExamStatusFilterToken] && tokenAccessStatus[currentExamStatusFilterToken][b.id] && (tokenAccessStatus[currentExamStatusFilterToken][b.id].accessCount || 0) > 0);

                if (!isAccessedA && isAccessedB) return -1;
                if (isAccessedA && !isAccessedB) return 1;
            }

            // Urutan kedua: Berdasarkan kelas (numerik kemudian abjad)
            const classA = extractClassParts(a.class);
            const classB = extractClassParts(b.class);

            if (classA.num !== classB.num) {
                return classA.num - classB.num;
            }
            // Pastikan penyortiran abjad untuk karakter kelas (misalnya, A, B, C)
            if (classA.char !== classB.char) {
                return classA.char.localeCompare(classB.char);
            }

            // Urutan ketiga: Berdasarkan nama
            return String(a.name || '').localeCompare(String(b.name || '')); // Bandingkan nama dengan aman
        });

        // Loop rendering
        for (const student of studentsToDisplay) {
            counter++;
            const row = document.createElement('tr');
            let studentStatus = '';
            let statusColor = '';

            // Dapatkan kelas numerik siswa
            const studentNumericClass = getNumericClass(student.class);

            // Temukan semua token yang relevan untuk kelas siswa ini
            const relevantTokensForStudent = tokenCache.filter(token => 
                getNumericClass(token.kelas) === studentNumericClass
            );

            let hasSubmittedAnyRelevantToken = false;
            let hasActiveRelevantToken = false;
            let hasAccessedAnyRelevantToken = false;
            let hasPastActiveRelevantToken = false;
            let isLoggedInForAnyRelevantToken = false;
            let isResetForAnyRelevantToken = false;
            let totalAccessCount = 0;

            for (const token of relevantTokensForStudent) {
                const tokenAccessData = tokenAccessStatus[token.key] && tokenAccessStatus[token.key][student.id];
                // Menggunakan token.key sebagai parent node untuk submitted_exams
                const studentSubmissionData = submittedExamsCache[token.key] && submittedExamsCache[token.key][student.id];

                const isSubmitted = studentSubmissionData && studentSubmissionData.isSubmitted === true;
                const isTokenCurrentlyActive = token.isActive || token.isForceActive;
                const hasTokenStarted = now >= new Date(token.startTime);
                const hasAccessEntry = !!tokenAccessData; // Apakah ada entri di exam_access_status

                if (isSubmitted) {
                    hasSubmittedAnyRelevantToken = true;
                }
                if (isTokenCurrentlyActive) {
                    hasActiveRelevantToken = true;
                }
                if (hasTokenStarted) {
                    hasPastActiveRelevantToken = true;
                }
                if (hasAccessEntry) {
                    if (tokenAccessData.accessCount > 0) {
                        hasAccessedAnyRelevantToken = true;
                        totalAccessCount += tokenAccessData.accessCount;
                    }
                    if (tokenAccessData.isLoggedIn === true) {
                        isLoggedInForAnyRelevantToken = true;
                    }
                    if (tokenAccessData.isLoggedIn === false) {
                        isResetForAnyRelevantToken = true;
                    }
                }
            }

            if (hasSubmittedAnyRelevantToken) {
                studentStatus = 'Sudah submit';
                statusColor = 'green';
            } else if (hasActiveRelevantToken) {
                if (isLoggedInForAnyRelevantToken) {
                    if (hasAccessedAnyRelevantToken) {
                        studentStatus = `Sedang mengerjakan (${totalAccessCount})`;
                        statusColor = 'orange'; // Kuning/Oranye
                    } else {
                        studentStatus = 'Sedang mengerjakan'; // Login (Belum Akses)
                        statusColor = 'orange';
                    }
                } else if (isResetForAnyRelevantToken) {
                    studentStatus = 'Belum login (reset)';
                    statusColor = 'purple';
                } else { // Token aktif, tetapi tidak ada entri akses atau isLoggedIn false
                    studentStatus = 'Belum login';
                    statusColor = 'red';
                }
            } else if (hasPastActiveRelevantToken) { // Token sudah berlalu
                if (hasAccessedAnyRelevantToken) {
                    studentStatus = 'Belum submit'; // Pernah akses tapi belum submit
                    statusColor = 'red';
                } else {
                    studentStatus = 'Belum mengerjakan'; // Token sudah berlalu, belum pernah akses
                    statusColor = 'red';
                }
            } else { // Tidak ada token yang relevan atau token belum aktif
                studentStatus = '-';
                statusColor = 'black';
            }

            row.innerHTML = `
                <td>${counter}</td>
                <td>${student.id}</td>
                <td>${student.name}</td>
                <td>${student.class}</td>
                <td>${padRoomNumber(student.room)}</td> <td style="color: ${statusColor}; font-weight: bold;">${studentStatus}</td>
                <td>
                    <div class="student-action-buttons">
                        <button onclick="openEditStudentModal('${student.key}')" title="Edit Data Siswa">
                            <img src="${EDIT_ICON_URL}" alt="Edit">
                        </button>
                        <button onclick="openDeleteStudentConfirmModal('${student.key}')" title="Hapus Siswa">
                            <img src="${DELETE_ICON_URL}" alt="Hapus">
                        </button>
                        <button onclick="promptResetStudent('${student.key}', '${student.id}', '${student.name}', '${student.class}')" title="Reset Status Login">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button onclick="promptSubmitAnswer('${student.key}', '${student.id}', '${student.name}', '${student.class}')" title="Kirim Jawaban Manual">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button onclick="promptDeleteAnswer('${student.key}', '${student.id}', '${student.name}', '${student.class}')" title="Hapus Semua Jawaban">
                            <i class="fas fa-eraser"></i>
                        </button>
                    </div>
                </td>
            `;
            studentTableBody.appendChild(row);
        }
    }

    // Fungsi untuk memuat data siswa dari semua proyek Firebase (dengan real-time listener)
    function loadStudents() {
        studentCache = []; // Reset cache awal
        Object.keys(classDbMap).forEach(classNum => {
            const dbInstance = classDbMap[classNum];
            if (dbInstance) {
                onValue(ref(dbInstance, 'students'), (snapshot) => {
                    console.log(`[Real-time Update] Students for class ${classNum} updated.`);
                    const classStudents = [];
                    snapshot.forEach(child => {
                        const data = child.val();
                        data.key = child.key;
                        data.firebaseClass = classNum; // Simpan dari proyek Firebase mana asalnya
                        classStudents.push(data);
                    });

                    // Perbarui studentCache global dengan data terbaru dari kelas ini
                    // Hapus siswa lama dari kelas ini, lalu tambahkan yang baru
                    studentCache = studentCache.filter(s => s.firebaseClass !== classNum);
                    studentCache.push(...classStudents);

                    // Tambahkan penyortiran ke studentCache untuk memastikan urutan dasar yang konsisten
                    studentCache.sort((a, b) => {
                        const classA = extractClassParts(a.class);
                        const classB = extractClassParts(b.class);

                        if (classA.num !== classB.num) {
                            return classA.num - classB.num;
                        }
                        if (classA.char !== classB.char) {
                            return classA.char.localeCompare(classB.char);
                        }
                        return String(a.name || '').localeCompare(String(b.name || '')); // Bandingkan nama dengan aman
                    });
                    
                    populateClassFilter(); // Isi filter kelas setelah siswa dimuat
                    renderStudentTable(); // Render ulang tabel setiap kali data siswa berubah
                    renderScoreTable(); // Perbarui tabel nilai juga
                }, (error) => {
                    console.error(`Error memuat siswa dari kelas ${classNum}:`, error);
                });
            }
        });
    }

    // Event listener untuk formulir tambah/edit siswa
    studentForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const studentId = padStudentId(studentIdInput.value.trim()); // Isi ID
        const studentName = studentNameInput.value.trim().toUpperCase(); // Huruf besar otomatis
        const studentClass = studentClassInput.value.trim().toUpperCase(); // Huruf besar otomatis
        const studentRoom = padRoomNumber(studentRoomInput.value.trim()); // Dapatkan nilai ruangan dan isi
        studentErrorMsg.innerText = "";

        const targetDb = getDbForClass(studentClass);
        if (!targetDb) {
            studentErrorMsg.innerText = "Kelas siswa tidak valid atau konfigurasi Firebase belum lengkap untuk kelas ini (harus 7, 8, atau 9).";
            return;
        }

        // Validasi ID Siswa (harus numerik)
        if (!/^\d+$/.test(studentId)) {
            studentErrorMsg.innerText = "ID Siswa harus berupa angka!";
            return;
        }

        // Periksa ID siswa duplikat dalam cache database target
        const isIdDup = studentCache.some(s => s.id === studentId && s.key !== currentStudentKey && getNumericClass(s.class) === getNumericClass(studentClass));
        if (isIdDup) {
            studentErrorMsg.innerText = "ID Siswa sudah ada untuk kelas ini!";
            return;
        }

        // Bagian ini untuk menambahkan siswa baru.
        // Pengeditan sekarang ditangani oleh modal dan fungsi confirmEditStudent.
        push(ref(targetDb, 'students'), { id: studentId, name: studentName, class: studentClass, room: studentRoom, isLoggedIn: false }) // Tambahkan isLoggedIn: false secara default
            .then(() => {
                showNotification('Siswa berhasil ditambahkan.');
                studentForm.reset();
            })
            .catch(error => {
                studentErrorMsg.innerText = "Gagal menambahkan siswa: " + error.message;
            });
    });

    // Fungsi untuk membuka modal edit siswa
    window.openEditStudentModal = (key) => {
      const student = studentCache.find(s => s.key === key);
      if (!student) return;

      currentStudentKey = key; // Simpan kunci siswa yang sedang diedit
      modalStudentIdInput.value = student.id;
      modalStudentNameInput.value = student.name;
      modalStudentClassInput.value = student.class;
      modalStudentRoomInput.value = student.room || ''; // Isi input ruangan di modal edit, tangani jika tidak terdefinisi
      editStudentErrorMsg.innerText = ""; // Bersihkan pesan kesalahan sebelumnya
      editStudentModal.style.display = 'flex';
    };

    // Fungsi untuk mengkonfirmasi edit siswa dari modal
    window.confirmEditStudent = async () => { // Jadikan async
        const studentId = padStudentId(modalStudentIdInput.value.trim()); // Isi ID
        const studentName = modalStudentNameInput.value.trim().toUpperCase();
        const newStudentClass = modalStudentClassInput.value.trim().toUpperCase();
        const studentRoom = padRoomNumber(modalStudentRoomInput.value.trim()); // Dapatkan nilai ruangan dari modal dan isi
        editStudentErrorMsg.innerText = "";

        const originalStudentData = studentCache.find(s => s.key === currentStudentKey);
        if (!originalStudentData) {
            editStudentErrorMsg.innerText = "Data siswa asli tidak ditemukan.";
            return;
        }
        const oldStudentClass = originalStudentData.class;
        const oldDb = getDbForClass(oldStudentClass);
        const newDb = getDbForClass(newStudentClass);

        if (!oldDb || !newDb) {
            editStudentErrorMsg.innerText = "Kelas siswa tidak valid atau konfigurasi Firebase belum lengkap untuk kelas ini (harus 7, 8, atau 9).";
            return;
        }

        if (!studentId || !studentName || !newStudentClass || !studentRoom) {
            editStudentErrorMsg.innerText = "Semua field harus diisi!";
            return;
        }

        if (!/^\d+$/.test(studentId)) {
            editStudentErrorMsg.innerText = "ID Siswa harus berupa angka!";
            return;
        }

        // Periksa ID siswa duplikat di database target (jika kelas berubah)
        // Atau dalam database yang sama (jika kelas tidak berubah)
        const isIdDup = studentCache.some(s => 
            s.id === studentId && 
            s.key !== currentStudentKey && // Kecualikan siswa yang sedang diedit
            getNumericClass(s.class) === getNumericClass(newStudentClass) // Periksa terhadap nilai numerik kelas baru
        );
        if (isIdDup) {
            editStudentErrorMsg.innerText = "ID Siswa sudah ada untuk kelas ini!";
            return;
        }

        loadingOverlay.style.display = 'flex'; // Tampilkan loading

        const updatedStudentData = {
            id: studentId,
            name: studentName,
            class: newStudentClass,
            room: studentRoom,
            isLoggedIn: originalStudentData.isLoggedIn !== undefined ? originalStudentData.isLoggedIn : false // Pertahankan status isLoggedIn
        };

        try {
            if (getNumericClass(oldStudentClass) !== getNumericClass(newStudentClass)) {
                // Kelas telah berubah, lakukan operasi "pindah"
                console.log(`Siswa ${originalStudentData.id} dipindahkan dari kelas ${oldStudentClass} ke kelas ${newStudentClass}.`);

                // 1. Hapus siswa dari database lama
                await remove(ref(oldDb, 'students/' + currentStudentKey));
                console.log(`Siswa ${currentStudentKey} dihapus dari DB kelas ${oldStudentClass}.`);

                // 2. Hapus exam_access_status terkait untuk siswa ini dari database lama
                const tokensInOldClass = tokenCache.filter(t => getNumericClass(t.kelas) === getNumericClass(oldStudentClass));
                for (const token of tokensInOldClass) {
                    const accessPath = `exam_access_status/${token.key}/${originalStudentData.id}`;
                    const accessSnapshot = await get(ref(oldDb, accessPath)); // Periksa apakah jalur ada di targetDb
                    if (accessSnapshot.exists()) {
                        await remove(ref(oldDb, accessPath));
                    }
                }

                // 3. Hapus submitted_exams terkait untuk siswa ini dari database lama (menggunakan token.key)
                for (const token of tokensInOldClass) {
                    const submittedPath = `submitted_exams/${token.key}/${originalStudentData.id}`; 
                    const submittedSnapshot = await get(ref(oldDb, submittedPath)); 
                    if (submittedSnapshot.exists()) {
                        await remove(ref(oldDb, submittedPath));
                    }
                }

                // NEW: 4. Hapus student_answers terkait untuk siswa ini dari database lama (menggunakan token.key)
                for (const token of tokensInOldClass) {
                    const studentAnswersPath = `student_answers/${token.key}/${originalStudentData.id}`; 
                    const studentAnswersSnapshot = await get(ref(oldDb, studentAnswersPath)); 
                    if (studentAnswersSnapshot.exists()) {
                        await remove(ref(oldDb, studentAnswersPath));
                    }
                }

                // 5. Tambahkan siswa ke database baru
                await push(ref(newDb, 'students'), updatedStudentData);
                showNotification(`Siswa berhasil dipindahkan ke kelas ${newStudentClass}! Riwayat akses/pengiriman siswa di kelas lama telah direset.`);
            } else {
                // Kelas tidak berubah, cukup perbarui di database yang sama
                await update(ref(newDb, 'students/' + currentStudentKey), updatedStudentData);
                showNotification('Data siswa berhasil diperbarui.');
            }
            closeEditStudentModal();
        } catch (error) {
            editStudentErrorMsg.innerText = "Gagal memperbarui siswa: " + error.message;
            console.error("Error updating student:", error);
        } finally {
            loadingOverlay.style.display = 'none';
        }
    };

    // Fungsi untuk menutup modal edit siswa
    window.closeEditStudentModal = () => {
        editStudentModal.style.display = 'none';
        editStudentErrorMsg.innerText = "";
        currentStudentKey = null; // Reset kunci siswa yang sedang diedit
    };

    // Fungsi untuk membuka modal konfirmasi penghapusan siswa
    window.openDeleteStudentConfirmModal = (key) => {
        deleteStudentKey = key; // Simpan kunci siswa yang akan dihapus
        deleteStudentConfirmModal.style.display = 'flex';
    };

    // Fungsi untuk mengkonfirmasi penghapusan siswa
    window.confirmDeleteStudent = async () => { // Jadikan async
        if (deleteStudentKey) {
            const studentToDelete = studentCache.find(s => s.key === deleteStudentKey);
            if (!studentToDelete) {
                showNotification("Siswa tidak ditemukan.");
                closeDeleteStudentConfirmModal();
                return;
            }
            const studentId = studentToDelete.id; // Dapatkan ID siswa yang diisi
            const targetDb = getDbForClass(studentToDelete.class); // Dapatkan db berdasarkan kelas siswa
            if (!targetDb) {
                showNotification("Gagal menghapus: Database untuk kelas siswa tidak ditemukan.");
                closeDeleteStudentConfirmModal();
                return;
            }

            loadingOverlay.style.display = 'flex'; // Tampilkan loading

            try {
                // 1. Hapus catatan siswa itu sendiri dari database spesifiknya
                await remove(ref(targetDb, 'students/' + deleteStudentKey));

                // 2. Hapus status akses terkait untuk siswa ini di semua token (dari database spesifiknya)
                // Iterasi melalui token *dari kelas yang sama* dengan siswa
                const tokensInStudentClass = tokenCache.filter(t => getNumericClass(t.kelas) === getNumericClass(studentToDelete.class));
                for (const token of tokensInStudentClass) {
                    const accessPath = `exam_access_status/${token.key}/${studentId}`;
                    const accessSnapshot = await get(ref(targetDb, accessPath)); // Periksa apakah jalur ada di targetDb
                    if (accessSnapshot.exists()) {
                        await remove(ref(targetDb, accessPath));
                    }
                }

                // 3. Hapus submitted_exams terkait untuk siswa ini di semua token (dari database spesifiknya)
                for (const token of tokensInStudentClass) {
                    const submittedPath = `submitted_exams/${token.key}/${studentId}`; // Gunakan token.key di sini
                    const submittedSnapshot = await get(ref(targetDb, submittedPath)); // Periksa apakah jalur ada di targetDb
                    if (submittedSnapshot.exists()) {
                        await remove(ref(targetDb, submittedPath));
                    }
                }

                // NEW: 4. Hapus student_answers terkait untuk siswa ini di semua token (dari database spesifiknya)
                for (const token of tokensInStudentClass) {
                    const studentAnswersPath = `student_answers/${token.key}/${studentId}`; // Gunakan token.key di sini
                    const studentAnswersSnapshot = await get(ref(targetDb, studentAnswersPath)); // Periksa apakah jalur ada di targetDb
                    if (studentAnswersSnapshot.exists()) {
                        await remove(ref(targetDb, studentAnswersPath));
                    }
                }

                showNotification('Siswa dan semua data terkait berhasil dihapus.');
            } catch (error) {
                console.error("Gagal menghapus siswa dan data terkait:", error);
                showNotification("Gagal menghapus siswa dan data terkait: " + error.message);
            } finally {
                loadingOverlay.style.display = 'none'; // Sembunyikan loading
                closeDeleteStudentConfirmModal();
            }
        }
    };

    // Fungsi untuk menutup modal konfirmasi penghapusan siswa
    window.closeDeleteStudentConfirmModal = () => {
        deleteStudentConfirmModal.style.display = 'none';
        deleteStudentKey = null; // Reset kunci siswa yang akan dihapus
    };

    // --- Fungsi Impor Siswa dari CSV ---

    // Fungsi untuk membuka modal impor siswa
    window.openImportStudentModal = () => {
        importStudentModal.style.display = 'flex';
        csvFileInput.value = ''; // Bersihkan input file
        importFileError.innerText = ''; // Bersihkan kesalahan pesan
    };

    // Fungsi untuk menutup modal impor siswa
    window.closeImportStudentModal = () => {
        importStudentModal.style.display = 'none';
    };

    // Fungsi untuk menutup modal hasil impor
    window.closeImportResultModal = () => {
        importResultModal.style.display = 'none';
        importResultSummary.innerText = '';
        importResultDetails.innerHTML = '';
    };

    // Fungsi untuk memproses file CSV
    window.processCsvFile = async () => {
        if (isImporting) {
            showNotification('Proses impor sedang berjalan, harap tunggu.');
            return;
        }

        const file = csvFileInput.files[0];
        if (!file) {
            importFileError.innerText = 'Pilih file CSV terlebih dahulu.';
            return;
        }

        if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
            importFileError.innerText = 'File harus berformat CSV.';
            return;
        }

        importFileError.innerText = '';
        isImporting = true; // Set flag menjadi true
        loadingOverlay.style.display = 'flex'; // Tampilkan spinner loading

        const reader = new FileReader();

        reader.onload = async (e) => {
            const text = e.target.result;
            const lines = text.split('\n').filter(line => line.trim() !== '');

            let importedCount = 0;
            let skippedCount = 0;
            let errorDetails = [];
            
            // Objek untuk menampung pembaruan untuk setiap database
            const studentsToBatchUpdate7 = {};
            const studentsToBatchUpdate8 = {};
            const studentsToBatchUpdate9 = {};

            // Map untuk menyimpan objek batch mana yang akan digunakan
            const batchUpdateMap = {
                '7': studentsToBatchUpdate7,
                '8': studentsToBatchUpdate8,
                '9': studentsToBatchUpdate9
            };

            // Mulai membaca dari baris kedua (indeks 1) untuk melewati header
            const dataLines = lines.slice(1); 

            for (let i = 0; i < dataLines.length; i++) {
                const line = dataLines[i];
                // Coba pisahkan dengan koma terlebih dahulu
                let parts = line.split(',');
                let delimiter = ',';

                // Jika pemisahan koma tidak menghasilkan 4 bagian, coba titik koma
                if (parts.length !== 4) {
                    parts = line.split(';');
                    delimiter = ';';
                }

                const originalLineNumber = i + 2; // Nomor baris asli di file CSV (karena kita slice(1))

                if (parts.length !== 4) {
                    errorDetails.push(`Baris ${originalLineNumber}: Format tidak valid (diharapkan ID,Nama,Kelas,Ruang). Baris: "${line}"`);
                    skippedCount++;
                    continue;
                }

                const id = padStudentId(parts[0].trim());
                const name = parts[1].trim().toUpperCase();
                const studentClass = parts[2].trim().toUpperCase();
                const studentRoom = padRoomNumber(parts[3].trim());

                const numericClass = getNumericClass(studentClass);
                const targetBatch = batchUpdateMap[numericClass];
                const targetDb = getDbForClass(studentClass);

                if (!targetDb || !targetBatch) {
                    errorDetails.push(`Baris ${originalLineNumber}: Kelas siswa '${studentClass}' tidak valid atau konfigurasi Firebase belum lengkap untuk kelas ini.`);
                    skippedCount++;
                    continue;
                }

                // Validasi ID Siswa (harus numerik)
                if (!/^\d+$/.test(id)) {
                    errorDetails.push(`Baris ${originalLineNumber}: ID Siswa '${id}' tidak valid (harus angka).`);
                    skippedCount++;
                    continue;
                }

                // Validasi Nama Siswa (tidak boleh kosong)
                if (name === "") {
                    errorDetails.push(`Baris ${originalLineNumber}: Nama Siswa tidak boleh kosong.`);
                    skippedCount++;
                    continue;
                }

                // Periksa ID siswa duplikat di cache lokal (sebelum mendorong ke Firebase)
                const isIdDup = studentCache.some(s => s.id === id && getNumericClass(s.class) === numericClass);
                if (isIdDup) {
                    errorDetails.push(`Baris ${originalLineNumber}: Siswa dengan ID '${id}' sudah ada untuk kelas ${numericClass}, dilewati.`);
                    skippedCount++;
                    continue;
                }

                // Hasilkan kunci baru dan tambahkan ke objek pembaruan batch yang sesuai
                const newRef = push(ref(targetDb, 'students')); // Dapatkan referensi baru dengan kunci unik untuk db tertentu
                targetBatch[newRef.key] = { id: id, name: name, class: studentClass, room: studentRoom, isLoggedIn: false }; // Inisialisasi isLoggedIn
                importedCount++; // Tingkatkan segera untuk tujuan tampilan
            }

            try {
                const batchPromises = [];
                if (Object.keys(studentsToBatchUpdate7).length > 0) {
                    batchPromises.push(update(ref(db7, 'students'), studentsToBatchUpdate7));
                }
                if (Object.keys(studentsToBatchUpdate8).length > 0) {
                    batchPromises.push(update(ref(db8, 'students'), studentsToBatchUpdate8));
                }
                if (Object.keys(studentsToBatchUpdate9).length > 0) {
                    batchPromises.push(update(ref(db9, 'students'), studentsToBatchUpdate9));
                }
                
                await Promise.all(batchPromises);
                showNotification(`${importedCount} siswa berhasil diimpor!`);
            } catch (error) {
                console.error("Gagal melakukan impor batch:", error);
                showNotification(`Gagal mengimpor data: ${error.message}`);
                // Jika seluruh batch gagal, semua importedCount yang sebelumnya dihitung harus dianggap dilewati/gagal
                skippedCount += importedCount;
                importedCount = 0;
                errorDetails.push(`Kesalahan umum saat menyimpan ke Firebase: ${error.message}`);
            } finally {
                isImporting = false; // Reset flag setelah impor selesai
                loadingOverlay.style.display = 'none';
                closeImportStudentModal();
                displayImportResults(importedCount, skippedCount, errorDetails);
            }
        };

        reader.onerror = () => {
            isImporting = false; // Reset flag saat ada kesalahan juga
            loadingOverlay.style.display = 'none';
            importFileError.innerText = 'Gagal membaca file.';
        };

        reader.readAsText(file);
    };

    // Fungsi untuk menampilkan hasil impor
    function displayImportResults(importedCount, skippedCount, errorDetails) {
        importResultSummary.innerHTML = `Berhasil diimpor: <span style="font-weight: bold; color: green;">${importedCount}</span>, Dilewati/Gagal: <span style="font-weight: bold; color: orange;">${skippedCount}</span>.`;
        importResultDetails.innerHTML = '';

        if (errorDetails.length > 0) {
            errorDetails.forEach(detail => {
                const li = document.createElement('li');
                li.style.color = 'red';
                li.innerText = detail;
                importResultDetails.appendChild(li);
            });
        } else {
            const li = document.createElement('li');
            li.style.color = 'green';
            li.innerText = 'Semua data berhasil diimpor atau tidak ada masalah yang ditemukan.';
            importResultDetails.appendChild(li);
        }
        importResultModal.style.display = 'flex';
    }

    // --- Fungsi Kosongkan Daftar Siswa ---
    window.openEmptyStudentsModal = () => {
        emptyStudentsPasswordInput.value = ''; // Bersihkan kata sandi
        emptyStudentsPasswordError.innerText = ''; // Bersihkan kesalahan
        emptyStudentsModal.style.display = 'flex';
    };

    window.closeEmptyStudentsModal = () => {
        emptyStudentsModal.style.display = 'none';
    };

    window.confirmEmptyStudents = async () => {
        const password = emptyStudentsPasswordInput.value;
        if (password !== ADMIN_PASS) {
            emptyStudentsPasswordError.innerText = "Password salah!";
            return;
        }

        loadingOverlay.style.display = 'flex'; // Tampilkan spinner loading
        try {
            const deletePromises = [];
            Object.keys(classDbMap).forEach(classNum => {
                const dbInstance = classDbMap[classNum];
                if (dbInstance) {
                    deletePromises.push(remove(ref(dbInstance, 'students'))); // Hapus semua data siswa untuk setiap kelas
                    deletePromises.push(remove(ref(dbInstance, 'exam_access_status'))); // Hapus status akses untuk setiap kelas
                    deletePromises.push(remove(ref(dbInstance, 'submitted_exams'))); // Hapus status pengiriman untuk setiap kelas
                    deletePromises.push(remove(ref(dbInstance, 'student_answers'))); // NEW: Hapus jawaban siswa untuk setiap kelas
                }
            });
            await Promise.all(deletePromises);
            
            // Catatan: setlokasi diperlakukan sebagai global dan tetap di db7
            // Jika setlokasi juga per kelas, itu perlu ditambahkan ke loop di atas.

            showNotification('Semua data peserta berhasil dikosongkan!');
        } catch (error) {
            console.error("Gagal mengosongkan daftar peserta:", error);
            showNotification('Gagal mengosongkan daftar peserta: ' + error.message);
        } finally {
            loadingOverlay.style.display = 'none'; // Sembunyikan spinner loading
            closeEmptyStudentsModal();
        }
    };

    // --- Fungsi Filter Siswa (berdasarkan kelas) ---
    window.filterStudentsByClass = (filterValue) => {
        currentStudentClassFilter = filterValue === "" ? null : filterValue; // null untuk "SEMUA KELAS"
        renderStudentTable();
    };

    // Fungsi untuk mengisi dropdown filter kelas
    function populateClassFilter() {
        classFilterDropdownSelect.innerHTML = '<option value="">SEMUA KELAS</option>'; // Opsi default

        // Kumpulkan tingkat kelas unik (7, 8, 9) dan rombel (7A, 7B, dll.)
        const grades = new Set();
        const rombels = new Set();

        studentCache.forEach(student => {
            const classMatch = String(student.class || '').match(/^(\d+)([A-Z]+)?$/); // Akses student.class dengan aman
            if (classMatch) {
                const grade = classMatch[1];
                const rombel = classMatch[2];
                grades.add(parseInt(grade));
                if (rombel) {
                    rombels.add(student.class);
                }
            }
        });

        // Urutkan tingkat kelas secara numerik
        const sortedGrades = Array.from(grades).sort((a, b) => a - b);
        // Urutkan rombel secara abjad
        const sortedRombels = Array.from(rombels).sort((a, b) => {
            const classA = extractClassParts(a);
            const classB = extractClassParts(b);
            if (classA.num !== classB.num) {
                return classA.num - classB.num;
            }
            return classA.char.localeCompare(classB.char);
        });

        sortedGrades.forEach(grade => {
            // Tambahkan opsi "Semua Rombel X"
            const allRombelOption = document.createElement('option');
            allRombelOption.value = `${grade}_all`;
            allRombelOption.innerText = `KELAS ${grade} (SEMUA ROMBEL)`;
            classFilterDropdownSelect.appendChild(allRombelOption);

            // Tambahkan opsi rombel spesifik untuk tingkat kelas ini
            sortedRombels.filter(r => String(r || '').startsWith(String(grade))) // Akses r dengan aman
                         .forEach(rombel => {
                const rombelOption = document.createElement('option');
                rombelOption.value = rombel;
                rombelOption.innerText = rombel;
                classFilterDropdownSelect.appendChild(rombelOption);
            });
        });

        // Atur nilai yang dipilih jika filter aktif
        if (currentStudentClassFilter) {
            classFilterDropdownSelect.value = currentStudentClassFilter;
        } else {
            classFilterDropdownSelect.value = ""; // Pastikan "SEMUA KELAS" dipilih jika tidak ada filter
        }
    }


    // --- Fungsi Filter Siswa (berdasarkan status ujian/token) ---
    window.filterStudentsByExamStatus = (selectedTokenKey) => {
        currentExamStatusFilterToken = selectedTokenKey === "" ? null : selectedTokenKey;
        renderStudentTable();
    };

    // Fungsi untuk mengisi dropdown filter status ujian
    function populateExamStatusFilter() {
        examStatusFilterDropdown.innerHTML = '<option value="">TOKEN SAAT INI</option>'; // Teks diubah di sini
        tokenCache.forEach(token => {
            const option = document.createElement('option');
            option.value = token.key;
            option.innerText = `${token.token} (${token.subject} Kelas ${token.kelas})`;
            examStatusFilterDropdown.appendChild(option);
        });
        // Atur nilai yang dipilih jika filter aktif
        if (currentExamStatusFilterToken) {
            examStatusFilterDropdown.value = currentExamStatusFilterToken;
        }
    }

    /* --- Fungsi Manajemen Nilai Ujian (BARU) --- */

    // Fungsi untuk menyingkat nama mata pelajaran
    function abbreviateSubject(subjectName) {
        if (!subjectName) return '';
        const words = subjectName.split(' ').filter(w => w.length > 0);
        if (words.length === 0) return '';
        if (words.length === 1) {
            return words[0].substring(0, 3).toUpperCase();
        } else if (words.length === 2) {
            // Ambil huruf pertama dari suku kata pertama + huruf pertama dari suku kata kedua + huruf terakhir dari suku kata kedua
            return (words[0].charAt(0) + words[1].charAt(0) + words[1].slice(-1)).toUpperCase();
        } else if (words.length === 3) {
            // Ambil huruf pertama dari setiap suku kata
            return (words[0].charAt(0) + words[1].charAt(0) + words[2].charAt(0)).toUpperCase();
        } else if (words.length >= 4) {
            // Ambil 3 huruf depan dari setiap suku kata (atau kurang jika suku kata pendek)
            return words.map(word => word.substring(0, Math.min(3, word.length))).join('').toUpperCase();
        }
        return subjectName.toUpperCase(); // Fallback
    }

    /**
     * Fungsi untuk menghitung nilai berdasarkan string jawaban siswa dan kunci jawaban.
     * @param {string} studentAnswersString - String jawaban siswa yang dipisahkan koma (contoh: "A,B,C,D").
     * @param {string} answerKeyString - String kunci jawaban yang dipisahkan koma (contoh: "A,B,C,D").
     * @returns {number} Nilai yang dihitung.
     */
    function calculateScore(studentAnswersString, answerKeyString) {
        if (!answerKeyString || !studentAnswersString) return 0; // Tidak ada kunci jawaban atau jawaban siswa, nilai 0

        const correctAnswers = answerKeyString.split(',');
        const studentAnswers = studentAnswersString.split(','); // Parse string jawaban siswa
        const totalQuestions = correctAnswers.length;

        if (totalQuestions === 0) return 0; // Tidak ada soal, nilai 0

        let correctCount = 0;
        for (let i = 0; i < totalQuestions; i++) {
            // Pastikan kedua jawaban ada dan bandingkan
            // Jika jawaban siswa tidak ada (misal: A,,B,C), maka dianggap salah
            if (i < studentAnswers.length && studentAnswers[i].trim().toUpperCase() === correctAnswers[i].trim().toUpperCase()) {
                correctCount++;
            }
        }

        let score;
        if (totalQuestions === 30) {
            score = (correctCount / 30) * 100;
        } else if (totalQuestions === 40) {
            score = (correctCount / 40) * 100;
        } else if (totalQuestions === 50) {
            score = (correctCount / 50) * 100;
        } else {
            // Rumus umum untuk soal selain 30/40/50, pastikan 0-100
            score = (correctCount / totalQuestions) * 100;
        }

        // Pastikan nilai antara 0 dan 100
        score = Math.max(0, Math.min(100, score));

        // Bulatkan ke 2 angka desimal
        return parseFloat(score.toFixed(2));
    }

    // Fungsi untuk merender tabel nilai ujian
    function renderScoreTable() {
        scoreTableHeader.innerHTML = '<th>NO</th><th>NAMA SISWA</th><th>KELAS</th>'; // Reset header
        scoreTableBody.innerHTML = ''; // Reset body

        const subjects = new Set();
        // Kumpulkan semua mata pelajaran unik dari token yang sudah disubmit
        tokenCache.forEach(token => {
            // Hanya tambahkan subjek jika ada setidaknya satu siswa yang submit token ini
            // Atau jika ada jawaban siswa untuk token ini (karena jawaban siswa adalah sumber nilai)
            // Menggunakan token.key sebagai parent node untuk submitted_exams dan student_answers
            if ((submittedExamsCache[token.key] && Object.keys(submittedExamsCache[token.key]).length > 0) ||
                (studentAnswersCache[token.key] && Object.keys(studentAnswersCache[token.key]).length > 0)) {
                subjects.add(token.subject);
            }
        });
        const sortedSubjects = Array.from(subjects).sort((a, b) => a.localeCompare(b));

        // Tambahkan kolom mata pelajaran ke header
        sortedSubjects.forEach(subject => {
            const abbr = abbreviateSubject(subject); // Gunakan singkatan
            scoreTableHeader.innerHTML += `<th>${abbr}</th>`;
        });

        let studentsToDisplay = studentCache;

        // Filter berdasarkan angkatan (kelas 7, 8, 9)
        if (currentScoreGradeFilter) {
            studentsToDisplay = studentsToDisplay.filter(student => 
                getNumericClass(student.class) === String(currentScoreGradeFilter)
            );
            // Update active state for grade filter buttons
            document.querySelectorAll('.score-filters-container button').forEach(btn => {
                if (parseInt(btn.innerText.replace('Kelas ', '')) === currentScoreGradeFilter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        } else {
            // No filter, remove active class from all grade buttons
            document.querySelectorAll('.score-filters-container button').forEach(btn => btn.classList.remove('active'));
        }

        // Filter berdasarkan pencarian nama
        const searchName = scoreSearchNameInput.value.trim().toUpperCase();
        if (searchName) {
            studentsToDisplay = studentsToDisplay.filter(student => 
                String(student.name || '').toUpperCase().includes(searchName)
            );
        }

        // Filter berdasarkan pencarian kelas
        const searchClass = scoreSearchClassInput.value.trim().toUpperCase();
        if (searchClass) {
            studentsToDisplay = studentsToDisplay.filter(student => 
                String(student.class || '').toUpperCase().includes(searchClass)
            );
        }

        // Urutkan siswa (sama dengan tabel peserta)
        studentsToDisplay.sort((a, b) => {
            const classA = extractClassParts(a.class);
            const classB = extractClassParts(b.class);

            if (classA.num !== classB.num) {
                return classA.num - classB.num;
            }
            if (classA.char !== classB.char) {
                return classA.char.localeCompare(classB.char);
            }
            return String(a.name || '').localeCompare(String(b.name || ''));
        });

        let counter = 0;
        studentsToDisplay.forEach(student => {
            counter++;
            const row = document.createElement('tr');
            row.innerHTML = `<td>${counter}</td><td>${student.name}</td><td>${student.class}</td>`;

            sortedSubjects.forEach(subject => {
                let score = '-'; // Default jika tidak ada nilai
                const relevantToken = tokenCache.find(t => 
                    t.subject === subject && getNumericClass(t.kelas) === getNumericClass(student.class)
                );

                if (relevantToken) {
                    // Menggunakan token.key sebagai parent node untuk submitted_exams dan student_answers
                    const studentSubmission = submittedExamsCache[relevantToken.key] && submittedExamsCache[relevantToken.key][student.id];
                    const studentAnswerData = studentAnswersCache[relevantToken.key] && studentAnswersCache[relevantToken.key][student.id];

                    if (studentSubmission && studentSubmission.isSubmitted) {
                        const answerKey = relevantToken.answerKey; // Ambil kunci jawaban dari token
                        if (answerKey && studentAnswerData && studentAnswerData.answers) { // Pastikan ada jawaban siswa
                            score = calculateScore(studentAnswerData.answers, answerKey); // Kirim string jawaban
                        } else {
                            score = 'N/A'; // Kunci jawaban atau jawaban siswa tidak tersedia
                        }
                    }
                }
                row.innerHTML += `<td>${score}</td>`;
            });
            scoreTableBody.appendChild(row);
        });
    }

    // Fungsi untuk filter nilai berdasarkan angkatan
    window.filterScoresByGrade = (grade) => {
        currentScoreGradeFilter = grade;
        renderScoreTable();
    };

    // Fungsi untuk membuka modal cetak/salin generik
    window.openCopyPrintModal = (tableId, modalTitle) => {
        currentTableIdToCopy = tableId; // Simpan ID tabel yang akan disalin
        copyPrintModalTitle.innerText = modalTitle;
        copyPrintModal.style.display = 'flex';
    };

    // Fungsi untuk menutup modal cetak/salin generik
    window.closeCopyPrintModal = () => {
        copyPrintModal.style.display = 'none';
        currentTableIdToCopy = ''; // Reset ID tabel
    };

    // Fungsi untuk menyalin tabel ke clipboard
    window.copyTableToClipboard = () => {
        const table = document.getElementById(currentTableIdToCopy);
        if (!table) {
            showNotification('Tabel tidak ditemukan.');
            return;
        }

        // Buat tabel sementara untuk disalin agar tidak mengganggu tampilan asli
        const tempDiv = document.createElement('div');
        tempDiv.style.position = 'absolute';
        tempDiv.style.left = '-9999px'; // Pindahkan dari layar
        tempDiv.innerHTML = table.outerHTML;
        document.body.appendChild(tempDiv); 

        const range = document.createRange();
        range.selectNode(tempDiv);
        window.getSelection().removeAllRanges();
        window.getSelection().addRange(range);
        try {
            document.execCommand('copy');
            showNotification('Tabel berhasil disalin. Tempelkan ke Word atau Excel.');
        } catch (err) {
            console.error('Gagal menyalin tabel:', err);
            showNotification('Gagal menyalin tabel. Coba salin manual.');
        }
        window.getSelection().removeAllRanges();
        document.body.removeChild(tempDiv);
        closeCopyPrintModal();
    };

    // Fungsi untuk memperbarui jumlah soal berdasarkan input kunci jawaban
    function updateAnswerKeyCount(answerKeyInputElem, countInputElem) {
        const key = answerKeyInputElem.value.trim();
        const count = key === '' ? 0 : key.split(',').filter(v => v.trim() !== '').length;
        countInputElem.value = count;
    }

    // Event listener untuk input kunci jawaban di formulir tambah token
    answerKeyInput.addEventListener('input', () => {
        updateAnswerKeyCount(answerKeyInput, answerKeyCountInput);
    });

    // Event listener untuk input kunci jawaban di modal edit token
    editAnswerKeyInput.addEventListener('input', () => {
        updateAnswerKeyCount(editAnswerKeyInput, editAnswerKeyCountInput);
    });

    // Panggil update count saat halaman dimuat (untuk formulir tambah)
    document.addEventListener('DOMContentLoaded', () => {
        updateAnswerKeyCount(answerKeyInput, answerKeyCountInput);
    });

    /* --- Fungsi Reset Siswa --- */
    window.promptResetStudent = (key, id, name, studentClass) => {
        studentKeyForAction = key;
        studentIdForAction = id;
        studentClassForAction = studentClass;
        resetStudentNameDisplay.innerText = name;
        resetStudentIdDisplay.innerText = id;
        resetStudentModal.style.display = 'flex';
    };

    window.confirmResetStudent = async () => {
        if (studentKeyForAction && studentIdForAction && studentClassForAction) {
            const targetDb = getDbForClass(studentClassForAction);
            if (!targetDb) {
                showNotification("Gagal mereset: Database untuk kelas siswa tidak ditemukan.");
                closeResetStudentModal();
                return;
            }

            loadingOverlay.style.display = 'flex';
            try {
                // 1. Update isLoggedIn status for the specific student in 'students' node
                // Note: Per your request, the isLoggedIn status is now primarily driven by the exam_access_status node.
                // This update to the 'students' node might not be strictly necessary for the new status logic,
                // but keeping it for consistency if other parts of the app rely on it.
                await update(ref(targetDb, 'students/' + studentKeyForAction), { isLoggedIn: false });

                // 2. Update isLoggedIn status in 'exam_access_status' for all relevant tokens
                // Get numeric class of the student for filtering relevant tokens
                const studentNumericClass = getNumericClass(studentClassForAction);

                // Filter tokens that belong to the same numeric class as the student
                const relevantTokens = tokenCache.filter(token => 
                    getNumericClass(token.kelas) === studentNumericClass
                );

                for (const token of relevantTokens) {
                    const accessStatusPath = `exam_access_status/${token.key}/${studentIdForAction}`;
                    const accessSnapshot = await get(ref(targetDb, accessStatusPath));
                    if (accessSnapshot.exists()) {
                        // Only update if the node exists and has isLoggedIn property
                        const currentAccessData = accessSnapshot.val();
                        if (currentAccessData.isLoggedIn !== undefined) {
                            await update(ref(targetDb, accessStatusPath), { isLoggedIn: false });
                        }
                    }
                }

                showNotification(`Status login siswa ${studentIdForAction} berhasil direset.`);
            } catch (error) {
                console.error("Gagal mereset status login siswa:", error);
                showNotification("Gagal mereset status login siswa: " + error.message);
            } finally {
                loadingOverlay.style.display = 'none';
                closeResetStudentModal();
            }
        }
    };

    window.closeResetStudentModal = () => {
        resetStudentModal.style.display = 'none';
        studentKeyForAction = null;
        studentIdForAction = null;
        studentClassForAction = null;
    };

    /* --- Fungsi Kirim Jawaban Siswa --- */
    window.promptSubmitAnswer = (key, id, name, studentClass) => {
        studentKeyForAction = key;
        studentIdForAction = id;
        studentNameForAction = name;
        studentClassForAction = studentClass;
        submitStudentNameDisplay.innerText = name;
        submitStudentIdDisplay.innerText = id;
        submitAnswerModal.style.display = 'flex';
    };

    window.confirmSubmitAnswer = async () => {
        if (studentIdForAction && studentClassForAction) {
            const targetDb = getDbForClass(studentClassForAction);
            if (!targetDb) {
                showNotification("Gagal mengirim jawaban: Database untuk kelas siswa tidak ditemukan.");
                closeSubmitAnswerModal();
                return;
            }

            loadingOverlay.style.display = 'flex';
            try {
                // Find all relevant tokens for this student's class
                const relevantTokens = tokenCache.filter(token => 
                    getNumericClass(token.kelas) === getNumericClass(studentClassForAction)
                );

                const updates = {};
                for (const token of relevantTokens) {
                    // Use token.key for the path to submitted_exams
                    const studentSubmissionPath = `submitted_exams/${token.key}/${studentIdForAction}`;
                    const submissionSnapshot = await get(ref(targetDb, studentSubmissionPath));
                    const submissionData = submissionSnapshot.val();

                    if (submissionData && submissionData.isSubmitted === false) {
                        // If exists and not yet submitted, update it
                        updates[studentSubmissionPath + '/isSubmitted'] = true;
                        updates[studentSubmissionPath + '/timestamp'] = Date.now(); // Use timestamp as requested
                    } else if (!submissionData) {
                        // If no submission data exists, create a basic one and mark as submitted
                        updates[studentSubmissionPath] = {
                            isSubmitted: true,
                            timestamp: Date.now(), // Use timestamp as requested
                            answers: {} // Initialize with empty answers if none exist
                        };
                    }
                    // Note: If submissionData.isSubmitted is already true, do nothing.
                }

                if (Object.keys(updates).length > 0) {
                    await update(ref(targetDb, '/'), updates); // Apply all updates in a single batch
                    showNotification(`Jawaban siswa ${studentIdForAction} untuk ujian yang relevan berhasil ditandai sebagai 'Sudah submit'.`);
                } else {
                    showNotification(`Tidak ada ujian yang relevan untuk siswa ${studentIdForAction} yang perlu disubmit atau sudah disubmit.`);
                }
            } catch (error) {
                console.error("Gagal mengirim jawaban siswa:", error);
                showNotification("Gagal mengirim jawaban siswa: " + error.message);
            } finally {
                loadingOverlay.style.display = 'none';
                closeSubmitAnswerModal();
            }
        }
    };

    window.closeSubmitAnswerModal = () => {
        submitAnswerModal.style.display = 'none';
        studentKeyForAction = null;
        studentIdForAction = null;
        studentNameForAction = null;
        studentClassForAction = null;
    };

    /* --- Fungsi Hapus Jawaban Siswa --- */
    window.promptDeleteAnswer = (key, id, name, studentClass) => {
        studentKeyForAction = key;
        studentIdForAction = id;
        studentNameForAction = name;
        studentClassForAction = studentClass;
        deleteAnswerStudentNameDisplay.innerText = name;
        deleteAnswerStudentIdDisplay.innerText = id;
        deleteAnswerPasswordInput.value = ''; // Clear password
        deleteAnswerPasswordError.innerText = ''; // Clear error
        deleteAnswerModal.style.display = 'flex';
    };

    window.confirmDeleteAnswer = async () => {
        const password = deleteAnswerPasswordInput.value;
        if (password !== ADMIN_PASS) {
            deleteAnswerPasswordError.innerText = "Password salah!";
            return;
        }

        if (studentIdForAction && studentClassForAction) {
            const targetDb = getDbForClass(studentClassForAction);
            if (!targetDb) {
                showNotification("Gagal menghapus jawaban: Database untuk kelas siswa tidak ditemukan.");
                closeDeleteAnswerModal();
                return;
            }

            loadingOverlay.style.display = 'flex';
            try {
                // Find all relevant tokens for this student's class
                const relevantTokens = tokenCache.filter(token => 
                    getNumericClass(token.kelas) === getNumericClass(studentClassForAction)
                );

                for (const token of relevantTokens) {
                    // 1. Delete submitted_exams entry (using token.key)
                    const submissionPath = `submitted_exams/${token.key}/${studentIdForAction}`;
                    const submissionSnapshot = await get(ref(targetDb, submissionPath));
                    if (submissionSnapshot.exists()) {
                        await remove(ref(targetDb, submissionPath));
                        console.log(`Submitted exam for student ${studentIdForAction} and token ${token.token} deleted.`);
                    }

                    // 2. Delete student_answers entry (using token.key)
                    const studentAnswersPath = `student_answers/${token.key}/${studentIdForAction}`;
                    const studentAnswersSnapshot = await get(ref(targetDb, studentAnswersPath));
                    if (studentAnswersSnapshot.exists()) {
                        await remove(ref(targetDb, studentAnswersPath));
                        console.log(`Student answers for student ${studentIdForAction} and token ${token.token} deleted.`);
                    }

                    // 3. Delete exam_access_status entry (using token.key for path)
                    const accessStatusPath = `exam_access_status/${token.key}/${studentIdForAction}`;
                    const accessSnapshot = await get(ref(targetDb, accessStatusPath));
                    if (accessSnapshot.exists()) {
                        await remove(ref(targetDb, accessStatusPath));
                        console.log(`Exam access status for student ${studentIdForAction} and token ${token.token} deleted.`);
                    }
                }
                showNotification(`Semua jawaban dan status terkait siswa ${studentIdForAction} berhasil dihapus.`);
            } catch (error) {
                console.error("Gagal menghapus jawaban siswa:", error);
                showNotification("Gagal menghapus jawaban siswa: " + error.message);
            } finally {
                loadingOverlay.style.display = 'none';
                closeDeleteAnswerModal();
            }
        }
    };

    window.closeDeleteAnswerModal = () => {
        deleteAnswerModal.style.display = 'none';
        studentKeyForAction = null;
        studentIdForAction = null;
        studentNameForAction = null;
        studentClassForAction = null;
    };

  </script>
</body>
</html>
